const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DqOampk4.js","assets/index-Dqp3gZ1f.js","assets/index-DupMwUcW.css"])))=>i.map(i=>d[i]);
import{d as $,r as x,v as A,A as j,b as d,o as y,c as U,e as a,w as i,m as D,h as R,j as B,u as M,B as O,f as h,t as z,C as I,_ as L,i as F,a as G,S as T,E as P,D as H,x as J}from"./index-Dqp3gZ1f.js";const K={class:"cron-selector"},Q={key:2,class:"next-execution"},W=$({__name:"CronSelector",props:{modelValue:{}},emits:["update:modelValue"],setup(N,{emit:V}){let k=null;const f=async()=>(k||(k=(await I(()=>import("./index-DqOampk4.js").then(l=>l.i),__vite__mapDeps([0,1,2]))).default),k),p=N,o=V,u=x("0 2 * * *"),s=x(""),_=x(""),v=x(""),C=["0 2 * * *","0 3 * * *","0 */4 * * *","0 */12 * * *","0 0 * * 0"],n=async t=>{try{const l=await f();if(!l)return{valid:!1,error:"Cron解析器未加载"};const c=new l(t);c.reset();const g=c.next().toDate();return(c.next().toDate().getTime()-g.getTime())/(1e3*60)<60?{valid:!1,error:"备份任务定时最小间隔为1小时"}:{valid:!0}}catch{return{valid:!1,error:"Cron表达式格式无效"}}},e=async t=>{try{const l=await f();if(!l){v.value="";return}const g=new l(t).next().toDate();v.value=g.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{v.value=""}},b=async t=>{_.value="",console.log(t),t==="custom"?(s.value=p.modelValue||"0 2 * * *",await m(s.value)):await m(t)},w=async()=>{await m(s.value)},m=async t=>{await e(t),o("update:modelValue",t)};return A(async()=>{if(p.modelValue){console.log("加载初始值:",p.modelValue),C.includes(p.modelValue)?u.value=p.modelValue:(u.value="custom",s.value=p.modelValue);const t=await n(p.modelValue);t.valid?await e(p.modelValue):_.value=t.error||""}}),j(()=>p.modelValue,async t=>{if(t){if(C.includes(t))u.value!==t&&(u.value=t,_.value="",await e(t));else if(u.value!=="custom"||s.value!==t){u.value="custom",s.value=t;const l=await n(t);l.valid?(_.value="",await e(t)):_.value=l.error||""}}}),(t,l)=>{const c=d("el-option"),g=d("el-select"),E=d("el-input"),r=d("el-alert"),q=d("el-icon");return y(),U("div",K,[a(g,{modelValue:u.value,"onUpdate:modelValue":l[0]||(l[0]=S=>u.value=S),placeholder:"选择定时策略",onChange:b,style:{width:"100%"}},{default:i(()=>[a(c,{label:"每天凌晨2点",value:"0 2 * * *"}),a(c,{label:"每天凌晨3点",value:"0 3 * * *"}),a(c,{label:"每4小时",value:"0 */4 * * *"}),a(c,{label:"每12小时",value:"0 */12 * * *"}),a(c,{label:"每周日凌晨",value:"0 0 * * 0"}),a(c,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),u.value==="custom"?(y(),D(E,{key:0,modelValue:s.value,"onUpdate:modelValue":l[1]||(l[1]=S=>s.value=S),placeholder:"请输入 Cron 表达式，如: 0 2 * * *",onInput:w,style:{"margin-top":"12px"}},{prepend:i(()=>l[2]||(l[2]=[R("Cron")])),_:1},8,["modelValue"])):B("",!0),_.value?(y(),D(r,{key:1,title:_.value,type:"error",closable:!1,style:{"margin-top":"8px"}},null,8,["title"])):B("",!0),v.value&&!_.value?(y(),U("div",Q,[a(q,null,{default:i(()=>[a(M(O))]),_:1}),h("span",null,"下次执行时间："+z(v.value),1)])):B("",!0)])}}}),X=L(W,[["__scopeId","data-v-3e7faef8"]]),Y={class:"backup-settings-container"},Z={class:"page-header"},ee=$({__name:"AppBackupSettings",setup(N){let V=null;const k=async()=>(V||(V=(await I(()=>import("./index-DqOampk4.js").then(e=>e.i),__vite__mapDeps([0,1,2]))).default),V),f=F("$http"),p=J(),o=G({backup_enabled:1,backup_cron:"0 2 * * *",backup_path:"config/backups/",backup_retention:7,backup_max_count:10,backup_compress:1}),u=x(!1),s=x(""),_=async()=>{if(f)try{const n=await f.get(`${T}/database/backup-config`);if(n.data.code===200&&n.data.data.exists&&n.data.data.config){const e=n.data.data.config,b=e.backup_cron||"0 2 * * *";Object.assign(o,{backup_enabled:e.backup_enabled,backup_cron:b,backup_path:e.backup_path,backup_retention:e.backup_retention,backup_max_count:e.backup_max_count,backup_compress:e.backup_compress}),await C()}}catch(n){const e=n instanceof Error?n.message:"加载备份配置失败";P.error(e)}},v=async()=>{if(f){u.value=!0;try{(await f.post(`${T}/database/backup-config`,o)).data.code===200?(P.success("备份配置保存成功"),await C()):P.error("保存配置失败")}catch(n){const e=n instanceof Error?n.message:"保存配置失败";P.error(e)}finally{u.value=!1}}},C=async()=>{try{if(!o.backup_enabled||!o.backup_cron){s.value="";return}const n=await k();if(!n){s.value="";return}const b=new n(o.backup_cron).next().toDate();s.value=b.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{s.value=""}};return A(async()=>{await k(),_()}),(n,e)=>{const b=d("el-icon"),w=d("el-switch"),m=d("el-form-item"),t=d("el-input"),l=d("el-input-number"),c=d("el-button"),g=d("el-form"),E=d("el-alert");return y(),U("div",Y,[h("div",Z,[a(b,null,{default:i(()=>[a(M(H))]),_:1}),e[6]||(e[6]=h("span",null,"备份配置",-1))]),a(g,{ref:"configFormRef",model:o,"label-width":"120px","label-position":M(p)?"top":"right"},{default:i(()=>[a(m,{label:"启用自动备份"},{default:i(()=>[a(w,{modelValue:o.backup_enabled,"onUpdate:modelValue":e[0]||(e[0]=r=>o.backup_enabled=r),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),a(m,{label:"定时策略",required:""},{default:i(()=>[a(X,{modelValue:o.backup_cron,"onUpdate:modelValue":e[1]||(e[1]=r=>o.backup_cron=r)},null,8,["modelValue"])]),_:1}),a(m,{label:"备份路径",required:""},{default:i(()=>[a(t,{modelValue:o.backup_path,"onUpdate:modelValue":e[2]||(e[2]=r=>o.backup_path=r),placeholder:"例如: config/backups/"},null,8,["modelValue"])]),_:1}),a(m,{label:"保留天数",required:""},{default:i(()=>[a(l,{modelValue:o.backup_retention,"onUpdate:modelValue":e[3]||(e[3]=r=>o.backup_retention=r),min:1,max:365,"controls-position":"right"},null,8,["modelValue"]),e[7]||(e[7]=h("span",{style:{"margin-left":"8px",color:"#909399"}},"天",-1))]),_:1}),a(m,{label:"最大备份数",required:""},{default:i(()=>[a(l,{modelValue:o.backup_max_count,"onUpdate:modelValue":e[4]||(e[4]=r=>o.backup_max_count=r),min:1,max:100,"controls-position":"right"},null,8,["modelValue"]),e[8]||(e[8]=h("span",{style:{"margin-left":"8px",color:"#909399"}},"个",-1))]),_:1}),a(m,{label:"压缩备份"},{default:i(()=>[a(w,{modelValue:o.backup_compress,"onUpdate:modelValue":e[5]||(e[5]=r=>o.backup_compress=r),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),a(m,null,{default:i(()=>[a(c,{type:"primary",loading:u.value,onClick:v},{default:i(()=>e[9]||(e[9]=[R(" 保存配置 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model","label-position"]),s.value?(y(),D(E,{key:0,title:`下次自动备份时间：${s.value}`,type:"info",closable:!1},null,8,["title"])):B("",!0)])}}}),ae=L(ee,[["__scopeId","data-v-911a8878"]]);export{ae as default};
