import{d as F,i as h,G as w,r as k,b as c,c as B,f as i,e as a,w as l,u as o,j as M,E as n,M as V,S as N,o as R,N as T,h as d,O as G,t as g,J as L,K as D,x as I,_ as $}from"./index-Dqp3gZ1f.js";const j={class:"backup-restore-container"},A={class:"action-buttons"},P={key:0,class:"file-info"},Q=F({__name:"AppBackupRestore",setup(W){const v=h("$http"),p=w(),S=I(),f=k(),s=k(null),_=k(!1),q=t=>{var u,r;const e=t.raw;if(!e)return;if(![".sql",".sql.gz"].some(x=>e.name.toLowerCase().endsWith(x))){n.error("只支持 .sql 或 .sql.gz 格式的文件"),(u=f.value)==null||u.clearFiles();return}if(e.size>1073741824){n.error("文件大小不能超过 1GB"),(r=f.value)==null||r.clearFiles();return}s.value=e,n.success("文件已选择")},C=t=>{t.length>0&&n.warning("每次只能上传一个备份文件")},y=()=>{var t;s.value=null,(t=f.value)==null||t.clearFiles(),n.info("已清除选择的文件")},E=async()=>{if(!(!s.value||!v))try{await V.confirm("此操作将覆盖当前数据库，数据库将暂时不可用，确认继续吗？","危险操作确认",{confirmButtonText:"确认恢复",cancelButtonText:"取消",type:"error",confirmButtonClass:"el-button--danger"}),_.value=!0;const t=new FormData;t.append("backup_file",s.value);const e=await v.post(`${N}/database/restore`,t,{headers:{"Content-Type":"multipart/form-data"}});e.data.code===200?(n.success("恢复任务已启动"),p.startProgressPolling("restore",1,v),y()):n.error(e.data.message||"启动恢复任务失败")}catch(t){if(t!=="cancel"){const e=t instanceof Error?t.message:"启动恢复任务失败";n.error(e)}}finally{_.value=!1}};return(t,e)=>{const m=c("el-alert"),b=c("el-icon"),z=c("el-upload"),u=c("el-button"),r=c("el-descriptions-item"),x=c("el-descriptions");return R(),B("div",j,[e[4]||(e[4]=i("div",{class:"page-header"},[i("span",null,"数据库恢复")],-1)),a(m,{title:"警告：数据库恢复操作将覆盖当前数据库，请谨慎操作！",type:"error",closable:!1,style:{"margin-bottom":"20px"}}),a(m,{title:"恢复说明：仅支持 .sql 或 .sql.gz 格式的备份文件，文件大小不超过 1GB",type:"info",closable:!1,style:{"margin-bottom":"20px"}}),a(z,{ref_key:"uploadRef",ref:f,action:"#","auto-upload":!1,limit:1,accept:".sql,.sql.gz","on-change":q,"on-exceed":C,disabled:o(p).isRunning,drag:""},{tip:l(()=>e[0]||(e[0]=[i("div",{class:"el-upload__tip"}," 只支持 .sql / .sql.gz 文件，且不超过 1GB ",-1)])),default:l(()=>[a(b,{class:"el-icon--upload"},{default:l(()=>[a(o(T))]),_:1}),e[1]||(e[1]=i("div",{class:"el-upload__text"},[d(" 将备份文件拖到此处，或"),i("em",null,"点击选择文件")],-1))]),_:1},8,["disabled"]),i("div",A,[a(u,{type:"primary",size:"large",loading:_.value,disabled:!s.value||o(p).isRunning,onClick:E},{default:l(()=>[a(b,null,{default:l(()=>[a(o(G))]),_:1}),e[2]||(e[2]=i("span",null,"开始恢复",-1))]),_:1},8,["loading","disabled"]),a(u,{size:"large",disabled:!s.value||_.value||o(p).isRunning,onClick:y},{default:l(()=>e[3]||(e[3]=[d(" 清除 ")])),_:1},8,["disabled"])]),s.value?(R(),B("div",P,[a(x,{column:o(S)?1:2,border:""},{default:l(()=>[a(r,{label:"文件名"},{default:l(()=>[d(g(s.value.name),1)]),_:1}),a(r,{label:"文件大小"},{default:l(()=>[d(g(o(L)(s.value.size)),1)]),_:1}),a(r,{label:"文件类型"},{default:l(()=>[d(g(s.value.name.endsWith(".gz")?"SQL (压缩)":"SQL"),1)]),_:1}),a(r,{label:"最后修改"},{default:l(()=>[d(g(o(D)(s.value.lastModified/1e3)),1)]),_:1})]),_:1},8,["column"])])):M("",!0)])}}}),K=$(Q,[["__scopeId","data-v-7b3f95c9"]]);export{K as default};
