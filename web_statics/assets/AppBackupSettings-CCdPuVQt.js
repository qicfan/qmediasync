const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DmVRcdtd.js","assets/index-BQctmyle.js","assets/index-TiyNYGBV.css"])))=>i.map(i=>d[i]);
import{d as A,v as U,r as k,A as j,b as c,o as x,c as D,e as t,w as r,m as M,h as R,j as w,u as N,B as O,f as V,t as z,C as I,_ as L,i as F,a as G,S as $,E as P,D as H,x as J}from"./index-BQctmyle.js";const K={class:"cron-selector"},Q={key:2,class:"next-execution"},W=A({__name:"CronSelector",props:{modelValue:{}},emits:["update:modelValue"],setup(T,{emit:b}){let f=null;const g=async()=>{f||(f=(await I(()=>import("./index-DmVRcdtd.js").then(l=>l.i),__vite__mapDeps([0,1,2]))).default)};U(()=>{g()});const p=T,o=b,m=k("0 2 * * *"),s=k(""),_=k(""),v=k(""),y=["0 2 * * *","0 3 * * *","0 */4 * * *","0 */12 * * *","0 0 * * 0"],n=a=>{try{if(!f)return{valid:!1,error:"Cron解析器未加载"};const l=new f(a);l.reset();const i=l.next().toDate();return(l.next().toDate().getTime()-i.getTime())/(1e3*60)<60?{valid:!1,error:"备份任务定时最小间隔为1小时"}:{valid:!0}}catch{return{valid:!1,error:"Cron表达式格式无效"}}},e=a=>{try{if(!f){v.value="";return}const i=new f(a).next().toDate();v.value=i.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{v.value=""}},B=a=>{_.value="",a==="custom"?(s.value=p.modelValue||"0 2 * * *",d(s.value)):d(a)},C=()=>{d(s.value)},d=a=>{const l=n(a);l.valid?(_.value="",e(a),o("update:modelValue",a)):(_.value=l.error||"验证失败",v.value="")};return U(()=>{if(p.modelValue){y.includes(p.modelValue)?m.value=p.modelValue:(m.value="custom",s.value=p.modelValue);const a=n(p.modelValue);a.valid?e(p.modelValue):_.value=a.error||""}}),j(()=>p.modelValue,a=>{a&&a!==s.value&&m.value==="custom"&&(s.value=a,n(a).valid&&(_.value="",e(a)))}),(a,l)=>{const i=c("el-option"),h=c("el-select"),E=c("el-input"),u=c("el-alert"),q=c("el-icon");return x(),D("div",K,[t(h,{modelValue:m.value,"onUpdate:modelValue":l[0]||(l[0]=S=>m.value=S),placeholder:"选择定时策略",onChange:B,style:{width:"100%"}},{default:r(()=>[t(i,{label:"每天凌晨2点",value:"0 2 * * *"}),t(i,{label:"每天凌晨3点",value:"0 3 * * *"}),t(i,{label:"每4小时",value:"0 */4 * * *"}),t(i,{label:"每12小时",value:"0 */12 * * *"}),t(i,{label:"每周日凌晨",value:"0 0 * * 0"}),t(i,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),m.value==="custom"?(x(),M(E,{key:0,modelValue:s.value,"onUpdate:modelValue":l[1]||(l[1]=S=>s.value=S),placeholder:"请输入 Cron 表达式，如: 0 2 * * *",onInput:C,style:{"margin-top":"12px"}},{prepend:r(()=>l[2]||(l[2]=[R("Cron")])),_:1},8,["modelValue"])):w("",!0),_.value?(x(),M(u,{key:1,title:_.value,type:"error",closable:!1,style:{"margin-top":"8px"}},null,8,["title"])):w("",!0),v.value&&!_.value?(x(),D("div",Q,[t(q,null,{default:r(()=>[t(N(O))]),_:1}),V("span",null,"下次执行时间："+z(v.value),1)])):w("",!0)])}}}),X=L(W,[["__scopeId","data-v-f2cb8515"]]),Y={class:"backup-settings-container"},Z={class:"page-header"},ee=A({__name:"AppBackupSettings",setup(T){let b=null;const f=async()=>{b||(b=(await I(()=>import("./index-DmVRcdtd.js").then(e=>e.i),__vite__mapDeps([0,1,2]))).default)},g=F("$http"),p=J(),o=G({backup_enabled:1,backup_cron:"0 2 * * *",backup_path:"config/backups/",backup_retention:7,backup_max_count:10,backup_compress:1}),m=k(!1),s=k(""),_=async()=>{if(g)try{const n=await g.get(`${$}/database/backup-config`);if(n.data.code===200&&n.data.data.exists&&n.data.data.config){const e=n.data.data.config;Object.assign(o,{backup_enabled:e.backup_enabled,backup_cron:e.backup_cron,backup_path:e.backup_path,backup_retention:e.backup_retention,backup_max_count:e.backup_max_count,backup_compress:e.backup_compress}),y()}}catch(n){const e=n instanceof Error?n.message:"加载备份配置失败";P.error(e)}},v=async()=>{if(g){m.value=!0;try{(await g.post(`${$}/database/backup-config`,o)).data.code===200?(P.success("备份配置保存成功"),y()):P.error("保存配置失败")}catch(n){const e=n instanceof Error?n.message:"保存配置失败";P.error(e)}finally{m.value=!1}}},y=()=>{try{if(!b||!o.backup_enabled||!o.backup_cron){s.value="";return}const e=new b(o.backup_cron).next().toDate();s.value=e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}catch{s.value=""}};return U(async()=>{await f(),_()}),(n,e)=>{const B=c("el-icon"),C=c("el-switch"),d=c("el-form-item"),a=c("el-input"),l=c("el-input-number"),i=c("el-button"),h=c("el-form"),E=c("el-alert");return x(),D("div",Y,[V("div",Z,[t(B,null,{default:r(()=>[t(N(H))]),_:1}),e[6]||(e[6]=V("span",null,"备份配置",-1))]),t(h,{ref:"configFormRef",model:o,"label-width":"120px","label-position":N(p)?"top":"right"},{default:r(()=>[t(d,{label:"启用自动备份"},{default:r(()=>[t(C,{modelValue:o.backup_enabled,"onUpdate:modelValue":e[0]||(e[0]=u=>o.backup_enabled=u),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),t(d,{label:"定时策略",required:""},{default:r(()=>[t(X,{modelValue:o.backup_cron,"onUpdate:modelValue":e[1]||(e[1]=u=>o.backup_cron=u)},null,8,["modelValue"])]),_:1}),t(d,{label:"备份路径",required:""},{default:r(()=>[t(a,{modelValue:o.backup_path,"onUpdate:modelValue":e[2]||(e[2]=u=>o.backup_path=u),placeholder:"例如: config/backups/"},null,8,["modelValue"])]),_:1}),t(d,{label:"保留天数",required:""},{default:r(()=>[t(l,{modelValue:o.backup_retention,"onUpdate:modelValue":e[3]||(e[3]=u=>o.backup_retention=u),min:1,max:365,"controls-position":"right"},null,8,["modelValue"]),e[7]||(e[7]=V("span",{style:{"margin-left":"8px",color:"#909399"}},"天",-1))]),_:1}),t(d,{label:"最大备份数",required:""},{default:r(()=>[t(l,{modelValue:o.backup_max_count,"onUpdate:modelValue":e[4]||(e[4]=u=>o.backup_max_count=u),min:1,max:100,"controls-position":"right"},null,8,["modelValue"]),e[8]||(e[8]=V("span",{style:{"margin-left":"8px",color:"#909399"}},"个",-1))]),_:1}),t(d,{label:"压缩备份"},{default:r(()=>[t(C,{modelValue:o.backup_compress,"onUpdate:modelValue":e[5]||(e[5]=u=>o.backup_compress=u),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),t(d,null,{default:r(()=>[t(i,{type:"primary",loading:m.value,onClick:v},{default:r(()=>e[9]||(e[9]=[R(" 保存配置 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model","label-position"]),s.value?(x(),M(E,{key:0,title:`下次自动备份时间：${s.value}`,type:"info",closable:!1},null,8,["title"])):w("",!0)])}}}),ae=L(ee,[["__scopeId","data-v-6ea84d2d"]]);export{ae as default};
