import{d as Y,i as Z,G as ee,r as p,v as te,b as d,H as ae,c as L,f as E,e as s,w as o,u as l,j as v,S as b,E as i,o as f,k as se,I as N,m,h as u,t as _,J as P,K as A,L as oe,x as le,M as G,_ as ne}from"./index-BS09-Vw1.js";const re={class:"backup-records-container"},ie={class:"action-section"},ce={key:0,style:{"margin-left":"12px",color:"#909399"}},ue={class:"records-section"},de=Y({__name:"AppBackupRecords",setup(pe){const c=Z("$http"),w=ee(),r=le(),S=p("files"),z=p(!1),x=p(!1),B=p(!1),T=p([]),$=p([]),C=p(1),M=p(10),V=p(0),H=async()=>{if(c){z.value=!0;try{const t=await c.post(`${b}/database/backup/start`,{reason:"手动备份"});if(t.data.code===200){i.success("备份任务已启动");const a=t.data.data.task_id;w.startProgressPolling("backup",a,c),setTimeout(()=>{y(),k()},2e3)}else i.error(t.data.message||"启动备份任务失败")}catch(t){const a=t instanceof Error?t.message:"启动备份任务失败";i.error(a)}finally{z.value=!1}}},y=async()=>{if(c){x.value=!0;try{const t=await c.get(`${b}/database/backups`);t.data.code===200?T.value=t.data.data:i.error("加载备份文件列表失败")}catch(t){const a=t instanceof Error?t.message:"加载备份文件列表失败";i.error(a)}finally{x.value=!1}}},k=async()=>{if(c){B.value=!0;try{const t=await c.get(`${b}/database/backup-records`,{params:{page:C.value,page_size:M.value}});t.data.code===200?($.value=t.data.data.records,V.value=t.data.data.total):i.error("加载备份记录失败")}catch(t){const a=t instanceof Error?t.message:"加载备份记录失败";i.error(a)}finally{B.value=!1}}},J=async t=>{try{if(await G.confirm(`确定要删除备份文件 ${t} 吗？`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),!c)return;(await c.delete(`${b}/database/backup?filename=${encodeURIComponent(t)}`)).data.code===200?(i.success("备份文件已删除"),y()):i.error("删除备份文件失败")}catch(a){if(a!=="cancel"){const g=a instanceof Error?a.message:"删除备份文件失败";i.error(g)}}},K=async t=>{try{if(await G.confirm("确定要删除此备份记录吗？相关的备份文件也将被删除。","确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),!c)return;(await c.post(`${b}/database/backup-record/delete`,{record_id:t})).data.code===200?(i.success("备份记录已删除"),k(),y()):i.error("删除备份记录失败")}catch(a){if(a!=="cancel"){const g=a instanceof Error?a.message:"删除备份记录失败";i.error(g)}}},D=t=>{switch(t){case"completed":return"success";case"failed":return"danger";case"cancelled":return"info";case"timeout":return"warning";default:return""}},I=t=>{switch(t){case"completed":return"成功";case"failed":return"失败";case"cancelled":return"已取消";case"timeout":return"超时";case"running":return"运行中";default:return t}};return te(()=>{y(),k()}),(t,a)=>{const g=d("el-icon"),R=d("el-button"),q=d("el-alert"),n=d("el-table-column"),h=d("el-tag"),U=d("el-table"),j=d("el-tab-pane"),O=d("el-tooltip"),Q=d("el-pagination"),W=d("el-tabs"),F=ae("loading");return f(),L("div",re,[E("div",ie,[s(R,{type:"primary",size:"large",loading:z.value,disabled:l(w).isRunning,onClick:H},{default:o(()=>[s(g,null,{default:o(()=>[s(l(se))]),_:1}),a[3]||(a[3]=E("span",null,"手动备份",-1))]),_:1},8,["loading","disabled"]),l(w).isRunning?(f(),L("span",ce," 备份正在进行中... ")):v("",!0)]),E("div",ue,[s(W,{modelValue:S.value,"onUpdate:modelValue":a[2]||(a[2]=e=>S.value=e)},{default:o(()=>[s(j,{label:"备份文件",name:"files"},{default:o(()=>[s(q,{title:"备份文件存储在服务器的备份目录中，如需下载请直接访问服务器路径",type:"info",closable:!1,style:{"margin-bottom":"16px"}}),N((f(),m(U,{data:T.value,height:l(r)?"auto":400,style:{width:"100%"}},{default:o(()=>[s(n,{prop:"filename",label:"文件名","min-width":l(r)?150:250,"show-overflow-tooltip":""},null,8,["min-width"]),s(n,{prop:"file_size",label:"文件大小",width:l(r)?100:120},{default:o(({row:e})=>[u(_(l(P)(e.file_size)),1)]),_:1},8,["width"]),l(r)?v("",!0):(f(),m(n,{key:0,prop:"table_count",label:"表数量",width:"100"})),s(n,{prop:"backup_type",label:"类型",width:"100"},{default:o(({row:e})=>[s(h,{type:e.backup_type==="manual"?"primary":"info",size:"small"},{default:o(()=>[u(_(e.backup_type==="manual"?"手动":"自动"),1)]),_:2},1032,["type"])]),_:1}),s(n,{prop:"modified_time",label:"创建时间",width:l(r)?100:180},{default:o(({row:e})=>[u(_(l(A)(e.modified_time)),1)]),_:1},8,["width"]),s(n,{label:"操作",width:l(r)?80:100,fixed:"right"},{default:o(({row:e})=>[s(R,{type:"danger",size:"small",link:"",onClick:X=>J(e.filename)},{default:o(()=>a[4]||(a[4]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:1},8,["width"])]),_:1},8,["data","height"])),[[F,x.value]])]),_:1}),s(j,{label:"历史记录",name:"records"},{default:o(()=>[N((f(),m(U,{data:$.value,height:l(r)?"auto":400,style:{width:"100%"}},{default:o(()=>[s(n,{prop:"id",label:"ID",width:"80"}),s(n,{prop:"status",label:"状态",width:"100"},{default:o(({row:e})=>[e.status==="failed"&&e.failure_reason?(f(),m(O,{key:0,content:e.failure_reason,placement:"top"},{default:o(()=>[s(h,{type:D(e.status),size:"small"},{default:o(()=>[u(_(I(e.status)),1)]),_:2},1032,["type"])]),_:2},1032,["content"])):(f(),m(h,{key:1,type:D(e.status),size:"small"},{default:o(()=>[u(_(I(e.status)),1)]),_:2},1032,["type"]))]),_:1}),l(r)?v("",!0):(f(),m(n,{key:0,prop:"file_size",label:"文件大小",width:"120"},{default:o(({row:e})=>[u(_(e.file_size?l(P)(e.file_size):"-"),1)]),_:1})),s(n,{prop:"backup_duration",label:"耗时",width:"100"},{default:o(({row:e})=>[u(_(e.backup_duration?l(oe)(e.backup_duration):"-"),1)]),_:1}),s(n,{prop:"backup_type",label:"类型",width:"100"},{default:o(({row:e})=>[s(h,{type:e.backup_type==="manual"?"primary":"info",size:"small"},{default:o(()=>[u(_(e.backup_type==="manual"?"手动":"自动"),1)]),_:2},1032,["type"])]),_:1}),l(r)?v("",!0):(f(),m(n,{key:1,prop:"created_reason",label:"原因","min-width":"120","show-overflow-tooltip":""})),s(n,{prop:"completed_at",label:"完成时间",width:l(r)?100:180},{default:o(({row:e})=>[u(_(e.completed_at?l(A)(e.completed_at):"-"),1)]),_:1},8,["width"]),s(n,{label:"操作",width:l(r)?80:100,fixed:"right"},{default:o(({row:e})=>[s(R,{type:"danger",size:"small",link:"",onClick:X=>K(e.id)},{default:o(()=>a[5]||(a[5]=[u(" 删除 ")])),_:2},1032,["onClick"])]),_:1},8,["width"])]),_:1},8,["data","height"])),[[F,B.value]]),s(Q,{"current-page":C.value,"onUpdate:currentPage":a[0]||(a[0]=e=>C.value=e),"page-size":M.value,"onUpdate:pageSize":a[1]||(a[1]=e=>M.value=e),total:V.value,layout:l(r)?"prev, pager, next":"total, prev, pager, next, jumper",size:l(r)?"small":"default",style:{"margin-top":"16px","justify-content":"center"},onCurrentChange:k},null,8,["current-page","page-size","total","layout","size"])]),_:1})]),_:1},8,["modelValue"])])])}}}),_e=ne(de,[["__scopeId","data-v-f93c2a55"]]);export{_e as default};
