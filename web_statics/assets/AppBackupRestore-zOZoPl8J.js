import{d as h,j as w,v as V,r as y,a as c,c as k,m as r,e as a,f as l,u as o,i as q,E as n,B as M,S as D,b as z,C as T,h as d,D as A,t as m,y as N,A as P,q as G,_ as I}from"./index-Bn5yrwN7.js";const L={class:"backup-restore-container"},$={class:"action-buttons"},j={key:0,class:"file-info"},U=200,W=h({__name:"AppBackupRestore",setup(O){const v=w("$http"),p=V(),S=G(),f=y(),s=y(null),_=y(!1),E=t=>{var u,i;const e=t.raw;if(!e)return;if(![".sql",".zip"].some(x=>e.name.toLowerCase().endsWith(x))){n.error("只支持 .sql 或 .zip 格式的文件"),(u=f.value)==null||u.clearFiles();return}if(e.size>1073741824){n.error("文件大小不能超过 1GB"),(i=f.value)==null||i.clearFiles();return}s.value=e,n.success("文件已选择")},R=t=>{t.length>0&&n.warning("每次只能上传一个备份文件")},B=()=>{var t;s.value=null,(t=f.value)==null||t.clearFiles(),n.info("已清除选择的文件")},F=async()=>{if(!(!s.value||!v))try{await M.confirm("此操作将覆盖当前数据库，数据库将暂时不可用，确认继续吗？","危险操作确认",{confirmButtonText:"确认恢复",cancelButtonText:"取消",type:"error",confirmButtonClass:"el-button--danger"}),_.value=!0;const t=new FormData;t.append("file",s.value);const e=await v.post(`${D}/backup/upload-restore`,t,{headers:{"Content-Type":"multipart/form-data"},timeout:6e5});e.data.code===U?(n.success("恢复任务已启动"),p.startProgressPolling("restore",void 0,v),B()):n.error(e.data.message||"启动恢复任务失败")}catch(t){if(t!=="cancel"){const e=t instanceof Error?t.message:"启动恢复任务失败";n.error(e)}}finally{_.value=!1}};return(t,e)=>{const b=c("el-alert"),g=c("el-icon"),C=c("el-upload"),u=c("el-button"),i=c("el-descriptions-item"),x=c("el-descriptions");return z(),k("div",L,[e[4]||(e[4]=r("div",{class:"page-header"},[r("span",null,"数据库恢复")],-1)),a(b,{title:"警告：数据库恢复操作将覆盖当前数据库，请谨慎操作！",type:"error",closable:!1,style:{"margin-bottom":"20px"}}),a(b,{title:"恢复说明：仅支持 .sql 或 .zip 格式的备份文件，文件大小不超过 1GB",type:"info",closable:!1,style:{"margin-bottom":"20px"}}),a(C,{ref_key:"uploadRef",ref:f,action:"#","auto-upload":!1,limit:1,accept:".sql,.zip","on-change":E,"on-exceed":R,disabled:o(p).isRunning,drag:""},{tip:l(()=>e[0]||(e[0]=[r("div",{class:"el-upload__tip"}," 只支持 .sql / .zip 文件，且不超过 1GB ",-1)])),default:l(()=>[a(g,{class:"el-icon--upload"},{default:l(()=>[a(o(T))]),_:1}),e[1]||(e[1]=r("div",{class:"el-upload__text"},[d(" 将备份文件拖到此处，或"),r("em",null,"点击选择文件")],-1))]),_:1},8,["disabled"]),r("div",$,[a(u,{type:"primary",size:"large",loading:_.value,disabled:!s.value||o(p).isRunning,onClick:F},{default:l(()=>[a(g,null,{default:l(()=>[a(o(A))]),_:1}),e[2]||(e[2]=r("span",null,"开始恢复",-1))]),_:1},8,["loading","disabled"]),a(u,{size:"large",disabled:!s.value||_.value||o(p).isRunning,onClick:B},{default:l(()=>e[3]||(e[3]=[d(" 清除 ")])),_:1},8,["disabled"])]),s.value?(z(),k("div",j,[a(x,{column:o(S)?1:2,border:""},{default:l(()=>[a(i,{label:"文件名"},{default:l(()=>[d(m(s.value.name),1)]),_:1}),a(i,{label:"文件大小"},{default:l(()=>[d(m(o(N)(s.value.size)),1)]),_:1}),a(i,{label:"文件类型"},{default:l(()=>[d(m(s.value.name.endsWith(".zip")?"ZIP 压缩":"SQL"),1)]),_:1}),a(i,{label:"最后修改"},{default:l(()=>[d(m(o(P)(s.value.lastModified/1e3)),1)]),_:1})]),_:1},8,["column"])])):q("",!0)])}}}),Z=I(W,[["__scopeId","data-v-d0918ace"]]);export{Z as default};
