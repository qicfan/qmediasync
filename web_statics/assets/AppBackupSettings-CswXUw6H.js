import{d as $,r as g,o as h,w as M,a as i,b as m,c as f,e as o,f as u,g as j,h as S,i as q,_ as D,j as A,k as L,l as P,m as b,u as w,S as y,E as V,s as O,n as z,F as G,p as H,t as J,q as K}from"./index-xvM9OQmX.js";const Q={class:"cron-selector"},W=$({__name:"CronSelector",props:{modelValue:{}},emits:["update:modelValue"],setup(E,{emit:d}){const p=E,t=d,s=g("0 2 * * *"),l=g(""),_=["0 2 * * *","0 3 * * *","0 */4 * * *","0 */12 * * *","0 0 * * 0"],C=n=>{n==="custom"?(l.value=p.modelValue||"0 2 * * *",t("update:modelValue",l.value)):t("update:modelValue",n)},x=()=>{t("update:modelValue",l.value)};return h(()=>{p.modelValue&&(_.includes(p.modelValue)?s.value=p.modelValue:(s.value="custom",l.value=p.modelValue))}),M(()=>p.modelValue,n=>{n&&(_.includes(n)?s.value!==n&&(s.value=n):(s.value!=="custom"||l.value!==n)&&(s.value="custom",l.value=n))}),(n,a)=>{const e=i("el-option"),v=i("el-select"),k=i("el-input");return m(),f("div",Q,[o(v,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=c=>s.value=c),placeholder:"选择定时策略",onChange:C,style:{width:"100%"}},{default:u(()=>[o(e,{label:"每天凌晨2点",value:"0 2 * * *"}),o(e,{label:"每天凌晨3点",value:"0 3 * * *"}),o(e,{label:"每4小时",value:"0 */4 * * *"}),o(e,{label:"每12小时",value:"0 */12 * * *"}),o(e,{label:"每周日凌晨",value:"0 0 * * 0"}),o(e,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),s.value==="custom"?(m(),j(k,{key:0,modelValue:l.value,"onUpdate:modelValue":a[1]||(a[1]=c=>l.value=c),placeholder:"请输入 Cron 表达式，如: 0 2 * * *",onInput:x,style:{"margin-top":"12px"}},{prepend:u(()=>a[2]||(a[2]=[S("Cron")])),_:1},8,["modelValue"])):q("",!0)])}}}),X=D(W,[["__scopeId","data-v-2bfb9b46"]]),Y={class:"backup-settings-container"},Z={class:"page-header"},ee={key:0,class:"cron-next-times"},ae={class:"cron-times-list"},B=0,oe=$({__name:"AppBackupSettings",setup(E){const d=A("$http"),p=K(),t=L({backup_enabled:1,backup_cron:"0 3 * * *",backup_retention:7,backup_max_count:10,backup_compress:1}),s=g(!1),l=g([]),_=g(!1),C=async()=>{if(d)try{const a=await d.get(`${y}/backup/config`);if(a.data.code===B&&a.data.data){const e=a.data.data,v=e.backup_cron||"0 3 * * *";Object.assign(t,{backup_enabled:e.backup_enabled,backup_cron:v,backup_retention:e.backup_retention,backup_max_count:e.backup_max_count,backup_compress:e.backup_compress}),await n()}}catch(a){const e=a instanceof Error?a.message:"加载备份配置失败";V.error(e)}},x=async()=>{if(d){s.value=!0;try{const a=await d.put(`${y}/backup/config`,t);a.data.code===B?(V.success("备份配置保存成功"),await n()):V.error(a.data.message||"保存配置失败")}catch(a){const e=a instanceof Error?a.message:"保存配置失败";V.error(e)}finally{s.value=!1}}},n=async()=>{if(!t.backup_cron||!d){l.value=[];return}try{_.value=!0;const a=await d.get(`${y}/setting/cron`,{params:{cron:t.backup_cron}});(a==null?void 0:a.data.code)===200&&a.data.data?l.value=a.data.data||[]:l.value=[]}catch(a){console.error("查询Cron执行时间错误:",a),l.value=[]}finally{_.value=!1}};return M(()=>t.backup_cron,a=>{a&&a.trim()?n():l.value=[]}),h(()=>{C()}),(a,e)=>{const v=i("el-icon"),k=i("el-switch"),c=i("el-form-item"),F=i("el-tag"),U=i("el-input-number"),I=i("el-button"),N=i("el-form"),R=P("loading");return m(),f("div",Y,[b("div",Z,[o(v,null,{default:u(()=>[o(w(O))]),_:1}),e[5]||(e[5]=b("span",null,"备份配置",-1))]),o(N,{ref:"configFormRef",model:t,"label-width":"120px","label-position":w(p)?"top":"right"},{default:u(()=>[o(c,{label:"启用自动备份"},{default:u(()=>[o(k,{modelValue:t.backup_enabled,"onUpdate:modelValue":e[0]||(e[0]=r=>t.backup_enabled=r),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),o(c,{label:"定时策略",required:""},{default:u(()=>[o(X,{modelValue:t.backup_cron,"onUpdate:modelValue":e[1]||(e[1]=r=>t.backup_cron=r)},null,8,["modelValue"]),l.value.length>0?(m(),f("div",ee,[e[6]||(e[6]=b("p",null,[b("strong",null,"下5次执行时间：")],-1)),z((m(),f("div",ae,[(m(!0),f(G,null,H(l.value,(r,T)=>(m(),f("div",{key:T,class:"cron-time-item"},[o(F,{type:"info",size:"small"},{default:u(()=>[S(J(r),1)]),_:2},1024)]))),128))])),[[R,_.value]])])):q("",!0)]),_:1}),o(c,{label:"保留天数",required:""},{default:u(()=>[o(U,{modelValue:t.backup_retention,"onUpdate:modelValue":e[2]||(e[2]=r=>t.backup_retention=r),min:1,max:365,"controls-position":"right"},null,8,["modelValue"]),e[7]||(e[7]=b("span",{style:{"margin-left":"8px",color:"#909399"}},"天",-1))]),_:1}),o(c,{label:"最大备份数",required:""},{default:u(()=>[o(U,{modelValue:t.backup_max_count,"onUpdate:modelValue":e[3]||(e[3]=r=>t.backup_max_count=r),min:1,max:100,"controls-position":"right"},null,8,["modelValue"]),e[8]||(e[8]=b("span",{style:{"margin-left":"8px",color:"#909399"}},"个",-1))]),_:1}),o(c,{label:"压缩备份"},{default:u(()=>[o(k,{modelValue:t.backup_compress,"onUpdate:modelValue":e[4]||(e[4]=r=>t.backup_compress=r),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),o(c,null,{default:u(()=>[o(I,{type:"primary",loading:s.value,onClick:x},{default:u(()=>e[9]||(e[9]=[S(" 保存配置 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model","label-position"])])}}}),le=D(oe,[["__scopeId","data-v-0574d00d"]]);export{le as default};
