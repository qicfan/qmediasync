import{d as J,j as K,v as Q,r as _,o as W,a as d,l as X,c as $,m as S,e as s,f as o,u as r,i as y,S as v,E as c,b as m,x as Y,n as Z,g as h,h as g,t as b,y as ee,z as te,A as ae,q as se,B as oe,_ as ne}from"./index-pQL-oS7j.js";const re={class:"backup-records-container"},le={class:"action-section"},ce={key:0,style:{"margin-left":"12px",color:"#909399"}},ie={class:"records-section"},x=200,ue=J({__name:"AppBackupRecords",setup(de){const l=K("$http"),w=Q(),p=se(),R=_("records"),z=_(!1),C=_(!1),E=_([]),k=_(1),B=_(20),T=_(0),U=async()=>{if(l){z.value=!0;try{const e=await l.post(`${v}/backup/create`,{reason:"手动备份"});e.data.code===x?(c.success("备份任务已启动"),w.startProgressPolling("backup",void 0,l),setTimeout(()=>{f()},2e3)):c.error(e.data.message||"启动备份任务失败")}catch(e){const t=e instanceof Error?e.message:"启动备份任务失败";c.error(t)}finally{z.value=!1}}},f=async()=>{if(l){C.value=!0;try{const e=await l.get(`${v}/backup/list`,{params:{page:k.value,page_size:B.value,type:"all"}});e.data.code===x?(E.value=e.data.data.list,T.value=e.data.data.total):c.error("加载备份记录失败")}catch(e){const t=e instanceof Error?e.message:"加载备份记录失败";c.error(t)}finally{C.value=!1}}},V=()=>{k.value=1,f()},j=()=>{f()},D=e=>e&&e.split("/").pop()||"backup.sql.zip",L=async(e,t)=>{if(l)try{const i=await l.get(`${v}/backup/download/${e}`,{responseType:"blob"}),u=window.URL.createObjectURL(new Blob([i.data])),n=document.createElement("a");n.href=u,n.setAttribute("download",t),document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(u)}catch(i){const u=i instanceof Error?i.message:"下载备份文件失败";c.error(u)}},P=async e=>{try{if(await oe.confirm("确定要删除此备份记录吗？相关的备份文件也将被删除。","确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),!l)return;const t=await l.delete(`${v}/backup/records/${e}`);t.data.code===x?(c.success("备份记录已删除"),f()):c.error(t.data.message||"删除备份记录失败")}catch(t){if(t!=="cancel"){const i=t instanceof Error?t.message:"删除备份记录失败";c.error(i)}}},A=e=>{switch(e){case"completed":return"success";case"failed":return"danger";case"cancelled":return"info";case"timeout":return"warning";default:return""}},N=e=>{switch(e){case"completed":return"成功";case"failed":return"失败";case"cancelled":return"已取消";case"timeout":return"超时";case"running":return"运行中";case"pending":return"等待中";default:return e}};return W(()=>{f()}),(e,t)=>{const i=d("el-icon"),u=d("el-button"),n=d("el-table-column"),M=d("el-tag"),q=d("el-table"),F=d("el-pagination"),I=d("el-tab-pane"),O=d("el-tabs"),G=X("loading");return m(),$("div",re,[S("div",le,[s(u,{type:"primary",size:"large",loading:z.value,disabled:r(w).isRunning,onClick:U},{default:o(()=>[s(i,null,{default:o(()=>[s(r(Y))]),_:1}),t[3]||(t[3]=S("span",null,"手动备份",-1))]),_:1},8,["loading","disabled"]),r(w).isRunning?(m(),$("span",ce," 备份正在进行中... ")):y("",!0)]),S("div",ie,[s(O,{modelValue:R.value,"onUpdate:modelValue":t[2]||(t[2]=a=>R.value=a),onTabChange:j},{default:o(()=>[s(I,{label:"备份记录",name:"records"},{default:o(()=>[Z((m(),h(q,{data:E.value,height:r(p)?"auto":400,style:{width:"100%"}},{default:o(()=>[s(n,{prop:"id",label:"ID",width:"80"}),s(n,{prop:"status",label:"状态",width:"100"},{default:o(({row:a})=>[s(M,{type:A(a.status),size:"small"},{default:o(()=>[g(b(N(a.status)),1)]),_:2},1032,["type"])]),_:1}),r(p)?y("",!0):(m(),h(n,{key:0,prop:"file_size",label:"文件大小",width:"120"},{default:o(({row:a})=>[g(b(a.file_size?r(ee)(a.file_size):"-"),1)]),_:1})),s(n,{prop:"backup_duration",label:"耗时",width:"100"},{default:o(({row:a})=>[g(b(a.backup_duration?r(te)(a.backup_duration):"-"),1)]),_:1}),s(n,{prop:"backup_type",label:"类型",width:"100"},{default:o(({row:a})=>[s(M,{type:a.backup_type==="manual"?"primary":"info",size:"small"},{default:o(()=>[g(b(a.backup_type==="manual"?"手动":"自动"),1)]),_:2},1032,["type"])]),_:1}),r(p)?y("",!0):(m(),h(n,{key:1,prop:"created_reason",label:"原因","min-width":"120","show-overflow-tooltip":""})),s(n,{prop:"created_at",label:"创建时间",width:r(p)?100:180},{default:o(({row:a})=>[g(b(r(ae)(a.created_at)),1)]),_:1},8,["width"]),s(n,{label:"操作",width:r(p)?120:150,fixed:"right"},{default:o(({row:a})=>[a.status==="completed"?(m(),h(u,{key:0,type:"primary",size:"small",link:"",onClick:H=>L(a.id,D(a.file_path))},{default:o(()=>t[4]||(t[4]=[g(" 下载 ")])),_:2},1032,["onClick"])):y("",!0),s(u,{type:"danger",size:"small",link:"",onClick:H=>P(a.id)},{default:o(()=>t[5]||(t[5]=[g(" 删除 ")])),_:2},1032,["onClick"])]),_:1},8,["width"])]),_:1},8,["data","height"])),[[G,C.value]]),s(F,{"current-page":k.value,"onUpdate:currentPage":t[0]||(t[0]=a=>k.value=a),"page-size":B.value,"onUpdate:pageSize":t[1]||(t[1]=a=>B.value=a),total:T.value,layout:r(p)?"prev, pager, next":"total, prev, pager, next, jumper",size:r(p)?"small":"default","page-sizes":[10,20,50,100],style:{"margin-top":"16px","justify-content":"center"},onCurrentChange:f,onSizeChange:V},null,8,["current-page","page-size","total","layout","size"])]),_:1})]),_:1},8,["modelValue"])])])}}}),_e=ne(ue,[["__scopeId","data-v-fd6ed339"]]);export{_e as default};
