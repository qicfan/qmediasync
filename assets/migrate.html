<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库迁移 - QMediaSync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .steps-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step-indicator.active .step-number {
            background: #667eea;
            color: white;
        }

        .step-indicator.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step-indicator.active .step-label {
            color: #667eea;
            font-weight: 500;
        }

        .step-indicator.completed .step-label {
            color: #28a745;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }

        .btn:hover {
            background: #5a6fd6;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input[type="number"] {
            width: 100px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .message.info {
            background: #e7f3ff;
            color: #0c5460;
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar .progress {
            height: 100%;
            background: #667eea;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .install-guide {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .install-guide h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .install-guide pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin: 10px 0;
        }

        .install-guide code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .install-guide ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .install-guide li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .install-guide p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .install-guide .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .install-guide .tip {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .backup-status {
            text-align: center;
            padding: 20px;
        }

        .backup-status .status-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .backup-status .status-detail {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">数据库迁移向导</h1>
        <p class="subtitle">将数据从内嵌PostgreSQL迁移到外部PostgreSQL</p>

        <div class="steps-indicator">
            <div class="step-indicator {{if eq .step 1}}active{{end}} {{if gt .step 1}}completed{{end}}">
                <div class="step-number">1</div>
                <div class="step-label">备份数据</div>
            </div>
            <div class="step-indicator {{if eq .step 2}}active{{end}} {{if gt .step 2}}completed{{end}}">
                <div class="step-number">2</div>
                <div class="step-label">安装Postgres</div>
            </div>
            <div class="step-indicator {{if eq .step 3}}active{{end}} {{if gt .step 3}}completed{{end}}">
                <div class="step-number">3</div>
                <div class="step-label">配置连接</div>
            </div>
            <div class="step-indicator {{if eq .step 4}}active{{end}}">
                <div class="step-number">4</div>
                <div class="step-label">完成</div>
            </div>
        </div>

        <div id="message" class="message"></div>

        <div id="step-1" class="step {{if eq .step 1}}active{{end}}">
            <h3 style="margin-bottom: 15px; color: #333;">第一步：备份数据</h3>
            <p style="color: #666; margin-bottom: 20px;">
                在迁移之前，需要先备份当前数据库中的所有数据。备份文件将保存到：<br>
                <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">{{.backupPath}}</code>
            </p>
            
            <div id="backup-status" class="backup-status" style="display: none;">
                <div class="spinner"></div>
                <div class="progress-bar">
                    <div class="progress" id="backup-progress" style="width: 0%"></div>
                </div>
                <div class="status-text" id="backup-status-text">正在备份...</div>
                <div class="status-detail" id="backup-status-detail"></div>
            </div>

            <div class="btn-group">
                <button id="btn-backup" class="btn btn-success" onclick="startBackup()">开始备份</button>
            </div>
        </div>

        <div id="step-2" class="step {{if eq .step 2}}active{{end}} {{if eq .step 3}}active{{end}}">
            <h3 style="margin-bottom: 15px; color: #333;">第二步：安装PostgreSQL</h3>
            
            {{if .isDocker}}
            <div class="install-guide" id="docker-guide">
                <h3>Docker环境安装PostgreSQL</h3>
                
                <p style="margin-bottom: 15px;">
                    <strong>详细安装教程：</strong>
                    <a href="https://github.com/qicfan/qmediasync/wiki/Docker%E5%AE%89%E8%A3%85" target="_blank" style="color: #667eea;">
                        https://github.com/qicfan/qmediasync/wiki/Docker安装
                    </a>
                    <p>如果不明白怎么操作，加QQ群：1057459156 或者Telegram: https://t.me/q115_strm </p>
                </p>

                <h4 style="margin: 15px 0 10px;">使用 Docker Compose 和 外置 Postgres容器</h4>
                
                <p><strong>修改qms的docker-compose.yml（compose含postgres容器）：</strong></p>
                <pre>services:
  # 数据库服务
  postgres:
    image: postgres:17          # 使用官方 Postgres 镜像
    container_name: postgres        # 指定容器名称
    environment:
      POSTGRES_USER: postgres          # 数据库用户名
      POSTGRES_PASSWORD: "123123"      # 数据库密码
      POSTGRES_DB: postgres            # 默认创建的数据库名
    ports:
      - "15432:5432"                  # 将端口映射到宿主机，便于外部连接，这里映射的是15432端口，如果其他服务要用不要写错
    volumes:
      - ./postgres/data:/var/lib/postgresql/data # 数据持久化
    networks:
      qms:
        ipv4_address: 172.25.0.3

  qmediasync:
    image: qicfan/qmediasync:latest
    container_name: qmediasync
    restart: always
    depends_on:
      - postgres                       # 确保 postgres 服务先启动
    ports:
      - "12333:12333"                  # Web后台管理端口
      - "8095:8095"                    # Emby代理端口,302需要访问该端口
      #- "12332:12332"                 # https Web后台管理端口的
      #- "8094:8094"                   # https Emby代理端口
    volumes:
      - ./config:/app/config           # 必须有，运行日志和数据
      - /vol1/1000/网盘:/media         # 用来存放strm和元数据的目录，必须有，前后路径都可以自定义
    networks:
      qms:
        ipv4_address: 172.25.0.2
        
networks:
  qms:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16</pre>

                <p><strong>单独安装postgres容器：</strong></p>
                <pre>services:
  # 数据库服务
  postgres:
    image: postgres:17          # 使用官方 Postgres 镜像
    container_name: postgres        # 指定容器名称
    environment:
      POSTGRES_USER: postgres          # 数据库用户名
      POSTGRES_PASSWORD: "123123"      # 数据库密码
      POSTGRES_DB: postgres            # 默认创建的数据库名
    ports:
      - "15432:5432"                  # 将端口映射到宿主机，便于外部连接，这里映射的是15432端口，如果其他服务要用不要写错
    volumes:
      - ./postgres/data:/var/lib/postgresql/data # 数据持久化
    networks:
      qms:
        ipv4_address: 172.25.0.3
networks:
  qms:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16</pre>

                <div class="tip">
                    <strong>提示：</strong>确保postgres容器已经启动并运行正常后再进行下一步。
                </div>
            </div>
            {{else}}
            <div class="install-guide" id="windows-guide">
                <h3>Windows环境安装PostgreSQL</h3>
                
                <p style="margin-bottom: 15px;">
                    <strong>详细安装教程：</strong>
                    <a href="https://github.com/qicfan/qmediasync/wiki/Windows-%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8" target="_blank" style="color: #667eea;">
                        https://github.com/qicfan/qmediasync/wiki/Windows-安装使用
                    </a>
                    <p>如果不明白怎么操作，加QQ群：1057459156 或者Telegram: https://t.me/q115_strm </p>
                </p>
                
                <h4 style="margin: 15px 0 10px;">Postgres安装方式</h4>
                <ol>
                    <li>下载安装包，访问：<a href="https://www.enterprisedb.com/downloads/postgres-postgresql-downloads" target="_blank">PostgreSQL下载页面</a></li>
                    <li>在该页面上选择14或者15版本，然后下载windows_x86-64版本即可</li>
                    <li>安装下载好的软件，安装过程中记住设置的密码</li>
                    <li>安装完成后，PostgreSQL服务会自动启动</li>
                </ol>

                <div class="tip">
                    <strong>提示：</strong>安装完成后，请确保记住以下信息：
                    <ul style="margin-top: 10px;">
                        <li>主机地址（通常是 localhost）</li>
                        <li>端口（默认是 5432）</li>
                        <li>用户名（默认是 postgres）</li>
                        <li>密码（安装时设置的密码）</li>
                    </ul>
                </div>
            </div>
            {{end}}

            <div class="btn-group">
                <button class="btn" onclick="goToStep(3)">我已安装好PostgreSQL，下一步</button>
            </div>
        </div>

        <div id="step-3" class="step">
            <h3 style="margin-bottom: 15px; color: #333;">第三步：配置数据库连接</h3>
            <p style="color: #666; margin-bottom: 20px;">
                请输入外部PostgreSQL数据库的连接信息。一定要输入超级管理员用户名和密码，程序会自动创建指定的数据库。
            </p>

            <div class="form-group">
                <label for="host">主机地址</label>
                <input type="text" id="host" value="{{if .isWindows}}localhost{{else}}postgres{{end}}" oninput="onInputChanged()">
                <p style="font-size: 12px; color: #666; margin-top: 4px;">
                    如果使用第一种包含postgres和qmediasync的compose构建则输入 <code>postgres</code>；<br>
                    如果使用单独安装postgres的compose则输入 <code>172.25.0.1</code>
                </p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="port">端口</label>
                    <input type="number" id="port" value="5432" oninput="onInputChanged()">
                    <p style="font-size: 12px; color: #666; margin-top: 4px;">
                        如果主机地址是 <code>postgres</code>，端口为 <code>5432</code>；<br>
                        如果主机地址是 <code>172.25.0.1</code>，端口为 <code>15432</code>
                    </p>
                </div>
            </div>
            <div class="form-group">
                <label for="user">用户名</label>
                <input type="text" id="user" placeholder="postgres" value="postgres" oninput="onInputChanged()">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="输入密码" value="123123" oninput="onInputChanged()">
            </div>
            <div class="form-group">
                <label for="database">数据库名</label>
                <input type="text" id="database" value="qmediasync" oninput="onInputChanged()">
            </div>

            <div class="btn-group">
                <button id="btn-test" class="btn btn-secondary" onclick="testConnection()">测试连接</button>
                <button id="btn-save" class="btn btn-success" onclick="saveConfig()" disabled style="opacity: 0.5; cursor: not-allowed;">保存配置并退出</button>
            </div>
        </div>

        <div id="step-4" class="step">
            <h3 style="margin-bottom: 15px; color: #333;">迁移完成</h3>
            <div class="message success" style="display: block;">
                配置已保存！程序即将退出。
            </div>
            <p style="color: #666; margin-top: 20px;">
                请重新启动程序。重启后，程序将自动检测到备份文件并恢复数据到新的数据库。
            </p>
            <div class="message info" style="display: block; margin-top: 15px;">
                <strong>提示：</strong>恢复完成后，备份文件将被自动删除。
            </div>
        </div>
    </div>

    <script>
        let connectionTested = false;
        let backupCompleted = false;
        let statusCheckInterval = null;

        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step-' + stepNum).classList.add('active');

            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < stepNum) {
                    indicator.classList.add('completed');
                } else if (index + 1 === stepNum) {
                    indicator.classList.add('active');
                }
            });
        }

        function goToStep(stepNum) {
            showStep(stepNum);
        }

        function startBackup() {
            const btnBackup = document.getElementById('btn-backup');
            btnBackup.disabled = true;
            btnBackup.textContent = '正在备份...';

            document.getElementById('backup-status').style.display = 'block';

            fetch('/api/backup', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    startStatusCheck();
                } else {
                    showMessage('error', result.error || '启动备份失败');
                    btnBackup.disabled = false;
                    btnBackup.textContent = '开始备份';
                }
            })
            .catch(error => {
                showMessage('error', '请求失败: ' + error.message);
                btnBackup.disabled = false;
                btnBackup.textContent = '开始备份';
            });
        }

        function startStatusCheck() {
            statusCheckInterval = setInterval(checkBackupStatus, 1000);
        }

        function checkBackupStatus() {
            fetch('/api/backup-status')
            .then(response => response.json())
            .then(result => {
                if (result.total > 0) {
                    const progress = (result.count / result.total) * 100;
                    document.getElementById('backup-progress').style.width = progress + '%';
                }
                
                document.getElementById('backup-status-text').textContent = result.desc || '正在备份...';
                if (result.elapsed > 0) {
                    document.getElementById('backup-status-detail').textContent = 
                        '已用时间: ' + result.elapsed.toFixed(1) + '秒';
                }

                if (!result.is_running) {
                    clearInterval(statusCheckInterval);
                    backupCompleted = true;
                    
                    if (result.error_msg) {
                        showMessage('error', '备份失败: ' + result.error_msg);
                        document.getElementById('btn-backup').disabled = false;
                        document.getElementById('btn-backup').textContent = '重新备份';
                    } else {
                        showMessage('success', '备份完成！');
                        setTimeout(() => {
                            showStep(2);
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                console.error('检查状态失败:', error);
            });
        }

        function onInputChanged() {
            connectionTested = false;
            updateSaveButton();
            resetTestButton();
        }

        function updateSaveButton() {
            const btnSave = document.getElementById('btn-save');
            if (connectionTested) {
                btnSave.disabled = false;
                btnSave.style.opacity = '1';
                btnSave.style.cursor = 'pointer';
            } else {
                btnSave.disabled = true;
                btnSave.style.opacity = '0.5';
                btnSave.style.cursor = 'not-allowed';
            }
        }

        function resetTestButton() {
            const btnTest = document.getElementById('btn-test');
            btnTest.textContent = '测试连接';
            btnTest.style.background = '#6c757d';
        }

        function testConnection() {
            const host = document.getElementById('host').value;
            const port = parseInt(document.getElementById('port').value);
            const user = document.getElementById('user').value;
            const password = document.getElementById('password').value;
            const database = document.getElementById('database').value;

            if (!host || !user || !password || !database) {
                showMessage('error', '请填写所有必填字段');
                return;
            }

            const btnTest = document.getElementById('btn-test');
            btnTest.textContent = '测试中...';
            btnTest.disabled = true;

            fetch('/api/test-db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    host: host,
                    port: port,
                    user: user,
                    password: password,
                    database: database
                })
            })
            .then(response => response.json())
            .then(result => {
                btnTest.disabled = false;
                if (result.success) {
                    btnTest.textContent = '连接成功';
                    btnTest.style.background = '#28a745';
                    showMessage('success', result.message);
                    connectionTested = true;
                    updateSaveButton();
                } else {
                    btnTest.textContent = '测试连接';
                    btnTest.style.background = '#6c757d';
                    showMessage('error', result.error || '连接失败');
                    connectionTested = false;
                    updateSaveButton();
                }
            })
            .catch(error => {
                btnTest.textContent = '测试连接';
                btnTest.style.background = '#6c757d';
                btnTest.disabled = false;
                showMessage('error', '请求失败: ' + error.message);
                connectionTested = false;
                updateSaveButton();
            });
        }

        function saveConfig() {
            const data = {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                database: document.getElementById('database').value
            };

            if (!data.host || !data.user || !data.password || !data.database) {
                showMessage('error', '请填写所有必填字段');
                return;
            }

            const btnSave = document.getElementById('btn-save');
            btnSave.disabled = true;
            btnSave.textContent = '正在保存...';

            fetch('/api/save-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage('success', result.message);
                    setTimeout(() => {
                        showStep(4);
                    }, 1000);
                } else {
                    showMessage('error', result.error || '保存失败');
                    btnSave.disabled = false;
                    btnSave.textContent = '保存配置并退出';
                    updateSaveButton();
                }
            })
            .catch(error => {
                showMessage('error', '请求失败: ' + error.message);
                btnSave.disabled = false;
                btnSave.textContent = '保存配置并退出';
                updateSaveButton();
            });
        }

        function showMessage(type, text) {
            const messageEl = document.getElementById('message');
            messageEl.className = 'message ' + type;
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const currentStep = {{.step}};
            if (currentStep === 3) {
                showStep(3);
            }
        });
    </script>
</body>
</html>
