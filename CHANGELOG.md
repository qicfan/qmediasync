# Changelog



## v0.12.4 - 2026-01-24

### 修复

- #73 季nfo文件命名错误的问题（如果没有单独的季目录，应该命名为season01.nfo）

### 新增

- #14 增加API KEY功能，支持通过API Key进行接口认证和调用

## v0.12.3 - 2026-01-24

### 修复

- 同步和刮削任务队列的并发问题，每种类型每次只能有一个任务在执行（老版本可能会出现多个任务同时执行的情况，导致115请求超限）

### 新增

- 一键清除刮削记录

## v0.12.2 - 2026-01-24

### 修复

- 修复包含季文件夹的电视剧刮削无法成功的问题

### 新增

- 备份恢复（可定时备份，也可手动备份）
- Emby相关功能：
  - 同步Emby中的115网盘STRM到qms并建立Emby Item和115 File的关联
  - 同步Emby中媒体库到qms并建议Emby 媒体库和qms Strm同步目录的关联
  - Emby联动删除网盘功能
  - Strm同步完成后延迟1分钟通知Emby刷新媒体库



## v0.12.1 - 2026-01-23

### 修复

- 修复nfo中的originaltitle和sorttitle字段未正确生成的问题，正确的格式：name #(拼音首字母)和拼音首字母 #(name)

### 优化

- account表中的AppId改为AppIdName，防止AppId暴露导致的安全问题


## v0.12 - 2026-01-23

### 修复

- #71 电视剧刮削时如果有季文件夹因为使用了错误的字段导致季文件夹无法识别的问题

### 优化

- #69 刮削生成的nfo文件进行如下修改：
originaltitle字段将被修改成'$orig_title #($pinyin)'的形式，例如：我本是高山 #(wbsgs)，sorttitle将被修改为'$pinyin #($title)'，例如：wbsgs #(我本是高山)，这样就同时实现了拼音首字母搜索和排序。

- Emby入库和删除通知改为标准版，增加了媒体名称、简介、流派等信息，如果是电视剧还增加了季集编号、集主题，并且在入库通知中增加了海报图片的支持。

### 新增

- 重构通知模块
  - #60 支持MeoW通知渠道
  - #61 支持Bark通知渠道
  - #38 支持Server酱通知渠道
  - #70 支持自定义HTTP通知渠道


## v0.11.63 - 2026-01-19

### 修复

- 修复电视剧分类匹配时，国家和流派均命中但没有交集时，没有正确选择分类的问题
  - 优先选择流派命中的分类

### 优化

- 新增一种strm链接的格式：/115/url/video.iso?pickcode=xxxx&user_id=xxx&name=xxxxx
  - 路径最后一部分以文件扩展名结尾可以让部分播放器（coreelec kodi插件）正常播放iso等视频文件


## v0.11.62 - 2026-01-17

### 修复

- iso文件生成strm时，将规则改回name.strm，防止封面和nfo因为名称不一致无法被识别的问题
- 修复刮削115电视剧时，删除来源目录的逻辑：
  - 只有电视剧目录下没有任何目录时才会触发删除电视剧目录（防止误删季目录导致其他季下的集刮削失败）
- 修复剧、集、季的nfo文件生成时没有添加XML头和缩进的问题
- 修复集nfo文件中的XML根节点名称错误的问题
- 修复刮削115网盘电视剧时，没有正确处理剧和季目录导致刮削慢，每集都重新刮削剧元数据的问题

### 新增

- Emby媒体删除通知支持发送系统通知
- Emby媒体入库通知支持发送系统通知
- 收到Emby媒体入库通知后触发媒体信息提取


## v0.11.61 - 2025-12-18

### 修复

- 修复下载元数据时如果下载连接302跳转会报403的问题（主要是openlist中部分网盘会有问题)

## v0.11.60 - 2025-12-18

### 修复

- 修复添加刮削目录时，电视剧不能选择仅整理的问题

## v0.11.59 - 2025-12-17

### 修复

- fix #25 添加刮削目录选择目标路径时标题有误
- fix #24 文件，文件夹重命名模板链接错误
- fix #23 115网盘授权时未填写备注，添加刮削目录网盘账号显示空表（现在会显示115用户名）

## v0.11.58 - 2025-12-14

### 修复

- 修复STRM同步目录自定义设置的视频文件大小没生效的问题


## v0.11.57 - 2025-12-11

### 修复

- 修复补全路径时同目录下的文件的路径入库失败导致strm被删除或者元数据上传的问题


## v0.11.56 - 2025-12-11

### 修复

- 修复电视剧刮削识别时，季目录识别失败的问题
- 修复strm同步时排除的判断逻辑（如果某个目录被排除就不会再调用接口查询路径）


## v0.11.55 - 2025-12-10

### 修复

- 启动刮削时对于仅刮削类型不判断目标目录是否存在


## v0.11.54 - 2025-12-10

### 修复

- 修复文件名和文件名提取名称和年份的逻辑问题

### 优化
- 优化tmdb查询逻辑，当查询到多部电影时，判断第一个电影的标题或者原始标题是否和文件名提取的名称和年份一致，一致则认为是正确的电影
- 电影查询增加primary_release_year参数，如果通过year查询不到则使用primary_release_year查询


## v0.11.53 - 2025-12-10

### 修复

- 排除因为大小写问题不生效的bug
- strm设置排除没有转小写的bug
- openlist和本地目录strm同步时排除逻辑反了bug


## v0.11.52 - 2025-12-04

### 修复

- 修复元数据可能不触发上传的问题
- 修复STRM同步日志时区不对的问题
- 修复排除针对多级目录不生效的问题
- 修复前端STRM同步目录的自定义设置中排除名称会自动加.，导致后续判断失败的问题

### 优化
 
- STRM开始同步前检查115的连通性，防止误删文件
- STRM同步过程中，如果115接口报错则停止同步，防止误删文件
- 刮削同步开始时检查115目录ID是否存在，如果不存在则无法开始刮削整理
- 精简STRM同步时的日志输出，只输出必要信息
- docker支持环境变量配置用户和组，解决权限问题，默认用户为qms uid=12333 (qms) gid=12333 (qms) , 最好将qms和emby使用同一用户启动
- iso类型的文件，生成STRM时使用filename.iso.strm格式
- 元数据文件下载后将文件修改时间改为网盘文件的修改时间

### 新增

- 刮削重命名新增 {bitrate} 变量，用于表示视频的码率

### 问题

- 由于115接口对时间的返回不一致，所以strm和元数据都去掉时间判断
- 由于下载的文件经常有文件大小不一致的情况，所以去掉元数据文件的大小判断

## v0.11.51 - 2025-12-02

### 修复

- 修复docker在线更新只能生效一次的问题
- 修复strm链接生成时判断path是否为空的逻辑错误问题
    - 如果关闭了添加路径，会重新生成strm并去掉path字段
    - 如果打开了添加路径，会判断路径是否为空或者是否正确，
        - 如果为空，会重新生成strm并添加path字段
        - 如果不正确，会重新生成strm并修改path字段

### 优化

- STRM链接的path字段保留中文只编码特殊字符如/|,&?

## v0.11.50 - 2025-12-01

### 修复

- 修复linux-init.sh脚本，linux物理机现在可以通过脚本自动安装PG数据库并设置对应的环境变量，然后将QMediaSync添加为系统服务设置开机启动（需要systemctl支持）

### 新增

- STRM链接增加完整路径

## v0.11.49 - 2025-11-29
### 修复

- 修复添加刮削目录时，fanart.tv有时不现实的问题
- 修复电视剧刮削本地文件时剧的元数据路径错误导致元数据丢失的问题

### 新增

- 首页增加运行日志查看和下载
- STRM同步详情增加同步日志查看和下载
- 元数据增加文件大小校验，如果网盘文件大小和本地文件大小不同，则重新下载元数据


## v0.11.48 - 2025-11-29

### 修复

- 修复电视剧重新识别时部分数据清理不完整导致无法完成刮削的问题
- 修复仅刮削&非本地&没有季文件夹时会上传元数据失败的问题

### 遗留问题

- 电视剧回滚功能未实现


## v0.11.47 - 2025-11-28

### 修复

- 修复仅刮削电视剧如果没有季文件夹会上传元数据失败的问题
- 修复剧和集的演员头像链接没有增加域名的问题
- 修复电视剧刮削整理时过早删除了临时文件夹导致部分文件上传失败的问题

### 遗留问题

- 电视剧回滚功能未实现


## v0.11.46 - 2025-11-22

### 修复

- STRM同步时本地遗留的空目录直接删除（不管网盘有没有该空目录）
- 同步目录修改了视频和元数据扩展名没有生效的问题
- 如果同步目录的权限不是0777，会在创建目录时修改为0777；如果目录已存在会检查目录权限是否0777，如果不是才修改，防止因为权限修改导致文件修改时间变化。
- 修复编辑同步目录时扩展名无法保存、最小视频文件大小无法设置为0、其他设置无法保存的问题。
- 修复刮削电影时会提示90008的问题（这个错误码是115移动文件时源文件不存在的错误吗），原因是：有视频文件在来源根目录，刮削完该文件后删除了来源根目录导致其他文件都被删除了。
- 修复电影的来源根目录会被删除的问题
- 修复STRM同步时会丢失STRM的问题，因为数据库查询没有增加排序条件，导致乱序查询会随机丢失一些文件查不到。

### 新增

- 增加linux初始化脚本，根据参数安装和初始化数据库、设置为系统服务并开机启动、后台运行等。
- 电视剧刮削整理
- 电视剧支持{episode_name}命名变量

### 遗留问题
- 电视剧和电影刮削整理 openlist 类型没有测试
- 电视剧识别错误的回滚

## v0.11.45 - 2025-11-20

### 修复

- 修复电影刮削时如果多个视频在一个文件夹下会因为某一个视频刮削完成而把其他视频都删除的bug
- 修正电影二级分类的计算逻辑，优先级：精确命中流派+语言 > 精确命中流派 > 精确命中语言 > 无流派要求 > 无语言要求 > 默认分类
- 修复如果关闭了元数据下载且选择了保留元数据，也会在某个条件下删除元数据的问题

### 优化

- 115同步时使用路径代替文件id，避免因为文件id变化导致的同步问题

## v0.11.44 - 2025-11-20

### 修复

- 修复115同步可能报错的问题，原因：锁竞争


## v0.11.43 - 2025-11-19

### 修复

- 修复115同步可能报错的问题，原因：锁竞争
- 修复emby 302针对老版strm没有正确添加8095标识的问题
- 修复仅整理时因为没有查询tmdb其他信息可能导致空指针错误程序崩溃


### 优化

- 115的strm链接中增加userid（115用户id)参数，用于多设备共享strm时查询token


## v0.11.42 - 2025-11-18

### 修复

- 修复115或者openlist创建二级分类目录导致崩溃的问题
- 修复windows下由于PG版本过高导致无法启动数据库的问题
- 修复本地类型无法删除源目录的问题

### 新增

- windows可执行文件增加icon
- windows版本启动后会最小化到托盘图标，右键托盘图标可以退出程序；启动5秒后会自动打开浏览器并定位到http://localhost:12333

## v0.11.41 - 2025-11-09

### 修复

- 修复本地挂载目录同步 strm 时无法结束任务
- 修复 windows 和 docker 下 pg 数据库的已发现的权限问题，改用 pg_ctl 控制数据库服务启停

### 优化

- strm 文件的修改时间同源视频文件
- 继续优化文件夹权限，将 config 目录所有者改为 qms，权限 777
- 重构 strm 同步任务的停止机制，使用 context 控制任务的取消，联动取消 http 请求
- 重构刮削整理，降低内存占用，解决上一版部分 bug（op 无法完成文件收集,电视剧可能整理报错，临时文件误删导致无法上传等)
- emby 8095 端口取消电视剧集的排序修改（不会再将看过的集放到最后了）
- 优化刮削记录，将刮削目录的关键信息保存到刮削记录上，防止刮削目录删除或者修改导致刮削失败；刮削目录的修改只会影响后续的刮削任务
- 优化 PC 端和手机端 UI

### 新增

- 仅整理支持(不下载封面、不生成 nfo，只是将视频文件根据命名规则移动或复制到目标位置)
- 其他类型支持仅整理（必须有 nfo 文件，移动或者复制封面、字幕、nfo 文件到目标位置)
- 识别错误的影视剧增加回滚操作，根据刮削和整理设置将视频文件和字幕放回原位置，然后标记为待刮削（逻辑同重新识别）
- strm 同步目录的自定义设置将 strm 设置中的项全部加入

### 遗留问题

- 电视剧刮削整理暂时屏蔽，可以启动扫描和收集待刮削文件，但是不会执行刮削和整理。

## v0.11.40 - 2025-11-07

### 修复

- 修复 v0.11.38 版本导致在线更新失效的问题

## v0.11.39 - 2025-11-04

### 修复

- 修复 v0.11.38 版本导致在线更新失效的问题

## v0.11.38 - 2025-11-04

### 新增

- DOCKER 入口脚本增加环境变量设置 DOCKER 模式
- 在线更新 优先使用 http 网络代理，如未设置代理使用 github 代理

## v0.11.37 - 2025-11-04

### 修复

- 如果在线更新没完成就刷新页面，也会显示正确的进度

### 新增

- linux 支持外部 PG 数据库（通过环境变量配置连接参数）
- 8095 端口屏蔽 emby 忘记密码页面，防止 emby 密码爆破

## v0.11.36 - 2025-11-04

### 修复

### 优化

- 继续优化 PG 数据库权限

### 新增

- 115 网盘账号如果授权掉了，会显示刷新 token 失败的原因
- 首页新增版本列表，可以直接点击升级

### 遗留问题

- windows 版本没测试自动升级，如有问题下个版本修复

## v0.11.35 - 2025-11-04

### 修复

- 修复 openlist 刮削问题
- 修复 115 全量同步时可能部分文件夹路径没入库导致后续补充路径的情况
- 修复 strm 排除名称添加的时候自动加了.的问题
- 修复刮削目录添加编辑时 要删除的关键词 自动加了.的问题
- 修复 115 同步时来源根目录下的文件自动添加了一层文件夹的问题

### 优化

- 优化 115 全量逻辑，更稳定和更快速
- 继续优化启动时数据目录的创建和权限
- 115, openlist, 本地目录启用各自的同步和刮削任务队列，三种方式可以并行执行，会显著增加内存占用(理论上是以前版本的三倍，所以没必要的同步目录不要打开定时任务)

### 新增

- 上传下载队列新增清除所有完成和失败的任务的按钮

## v0.11.34 - 2025-11-04

### 修复

- 修复 openlist 无法同步 strm 的问题
- 修复编辑刮削目录时，删除整理完的非空路径 选项没有正确显示的问题

### 优化

- 启动时将上传中和下载中的记录改为待上传和待下载，好让上传下载继续完成

## v0.11.33 - 2025-11-04

### 修复

- 115 token 刷新没有更新全部 115 客户端的 token 导致可能同步失败的问题
- 上传下载队列限速没生效的问题

## v0.11.32 - 2025-11-04

### 修复

- openlist emby 302 多添加了一个参数，导致无法播放的问题
- 继续优化 Postgres 数据库权限问题，确保 qms 用户可以读写数据库相关的所有目录
- 修复所有创建的文件权限为 777,让 emby 可以删除

### 优化

- strm 同步目录添加编辑窗口，优化扩展名的输入，可以一次性输入多个逗号分隔的扩展名再回车统一加入
- 放开下载线程数设置

### 遗留问题

- openlist 同步依然存在问题，可能卡死，下个版本处理

## v0.11.31 - 2025-11-04

### 优化

- 继续优化 docker 权限问题
- 优化日志记录，添加微秒级时间戳，减少日志无用格式降低日志文件大小

### 修复

- 修复本地类型刮削目录无法修改刮削线程数的 bug

## v0.11.30 - 2025-11-03

### 修复

- 因为 postmaster.pid 存在导致 PG 启动失败，解决方案：统一使用 pg_ctl 启动停止(pg_ctl 会自动处理 postmaster.pid)
- 修复/media 或其他目录的权限问题，容器启动时会自动给/media 目录添加读写权限（666)，其他目录需要手动编辑同步目录或刮削目录（编辑或添加操作会修改目录权限）
- 修复刮削目录的最大线程数无法保存的 bug

### 优化

- 给 docker 容器添加 sudo 权限，解决在容器中执行需要 sudo 权限的命令问题
- 修改同步或刮削目录时，自动使用 sudo 给来源或目标目录添加读写权限（666）

## v0.11.29 - 2025-11-03

### 优化

- docker 镜像使用 qms 用户启动，解决 root 用户启动带来的一系列权限问题
- 数据库初始化脚本使用 qms 用户执行，避免权限问题

### 修复

- windows 包没有 PG 数据库可执行文件问题

### 其他未处理问题

- linux 和 mac 下现在没有 PG 数据库，需要手动安装并设置环境变量使用

## v0.11.28 - 2025-11-03

### 修复

- 减少初始化线程数量，防止内存溢出而崩溃(目前发现的问题时 openlist 同步崩溃，CD2 挂载同步崩溃，这两个都已修复)
- strm 同步和刮削目录，选择 openlist 目录时，也添加上级目录选项

### 优化

- 115 接口速率限制，将 strm 同步/刮削整理 和 普通操作区分，防止同步和刮削时阻塞普通操作（比如目录选择、播放等）

## v0.11.27 - 2025-11-02

### 修复

- 修复目录选择没有上一级的问题
- 修复同步目录列表运行状态后面一直跟一个未执行的问题
- 修复 strm 同步定时任务不会执行的问题

### 优化

- 播放链接关闭限速器，防止 strm 同步和刮削整理挤占 QPS 导致无法获取播放链接
- 去掉 strm 同步定时任务的半小时一次限制，现在可以完全自定义 CRON 表达式

### 新增

- 支持连接外部 PG 数据库，需要设置对应的环境变量
  - `DB_HOST` （外部数据库的主机名，如：192.168.1.1）
  - `DB_PORT` （外部数据库的端口 ，默认 `5432`）
  - `DB_USER` （外部数据库的用户名）
  - `DB_PASSWORD` （外部数据库的密码）
  - `DB_NAME` (外部数据库的数据库名称，可选，默认 `qms` 如果 qms 不存在且 USER 没有权限创建数据库则无法启动)
  - `DB_SSLMODE` (可选，默认 `disable`)

## v0.11.26 - 2025-11-02

### 修复

- 修复数据库初始化时，postgres 用户创建失败的问题
- 修复 docker 镜像没有默认安装 postgresql 的问题

## v0.11.25 - 2025-10-29

### 新增

- 数据库从 sqlite 迁移到 postgresql
- 上传下载队列迁移到数据库，减少内存占用，前端增加相应功能：
  - 查看上传下载队列
  - 暂停启动上传下载队列
  - 清空未完成的任务
- Openlist 和本地挂载类型的 STRM 同步，也使用接口速率中接口 QPS 来启动并发处理，提高效率
- 115 类型的 STRM 中的链接修改为：http://192.168.1.1:12333/115/newurl?pickcode=xxxxxxx
- openlist 类型的 STRM 中的链接修改为 openlist 文件链接：http://192.168.1.1:5244/d/xxxxxxx.mkv?sign=xxxxx
- 增加 AI 接口超时时间设置
- 如果识别时查询到多部影视剧，则停止识别并标记为错误，防止识别并整理到错的文件夹

### 优化

- 刮削目录添加或编辑时，如果是 115 类型，使用文件夹 ID 查询一次真实路径，防止错误
- 前端添加刮削目录独立页面，用户取消选择目录弹窗时，不处理后续的接口目录接口返回（防止意外选择错误文件夹）
- 同步任务详情页面删除比对数据，按照新的任务执行逻辑显示时间线
- strm 同步任务增加启动和停止功能，同步目录列表会显示当前同步目录的运行状态

### 修复

- 修复电影和电视剧二级分类计算不正确的问题

## v0.11.24 - 2025-10-28

### 优化

- 重构电视剧刮削逻辑，剧、季、集都增加 10 分钟超时，到期未响应或处理完就自动终止（下次再处理，防止卡死）
- 刮削整理增加了启动任务、停止任务
- 电视剧每一集处理完检查整部剧是否完成，这个过程增加处理队列保证唯一性（防止多次处理同一部剧）
- 优化刮削记录页面，重新设计表格，给每一个状态增加提示文字（显示这个状态的含义以及接下来会做什么）

### 修复

- 修复喝咖啡二维码某些设备不显示的巨大 bug

## v0.11.23 - 2025-10-27

### 修复

- 刮削记录搜索时总数没有跟随搜索条件变化
- AI 识别失败时会报空指针错误导致异常退出的问题
- 重构二级分类识别逻辑
- 视频扩展名没有取默认值的问题（重置表单会导致扩展名丢失）
- 修复 Openlist 整理时 改名错误，改为先 改名 后移动或复制
- 修复从文件夹名字中提取 tmdb id 的正则

### 优化

- 刮削记录名称搜素支持：文件路径或者识别名模糊搜索
- 8095 端口重定向时，如果链接包含 smartstrm，则不附加 force 参数
- emby 反代的 8094 和 8095 接口全部启用
- 优化刮削文件已存在的逻辑，减少误判
- 去掉单独的整理任务，合并刮削和整理，刮削完成立马整理
- 正则从文件名字中提取到年份+名字才会取 tmdb 查询，否则先从文件夹中提取名字+年份，合并数据后再查询

## v0.11.22 - 2025-10-27

### 修复

- 修复正则提取时如果文件命中提取的名称+年份搜不为空但是搜不到影片时也不会使用文件夹的信息搜索的问题。

### 优化

- 正则提取规则新增删除 xxfps 字样，例如：24fps

## v0.11.21 - 2025-10-27

### 修复

- 修复本地刮削整理时无法完成的问题（整理其实已经完成了，但是没有标记为已整理）

### 优化

- 整理电视剧时，会将正在处理的集改为整理中显示在页面上（仅优化页面显示，逻辑上没有变化）

## v0.11.20 - 2025-10-26

### 新增

- 刮削识别时新增一批正则匹配规则，可以提取更多格式的文件名

### 修复

- 修复整理完成发送通知时，可能产生的空指针错误

## v0.11.19 - 2025-10-26

### 修复

- 电影的文件夹名字的正则识别结果查询失败后，没有触发 AI 识别的问题
- 修复已本和 openlist 的已刮削文件列表记录了两次的问题

### 优化

- 记录更多刮削日志，方便排查问题
- 程序启动时，将所有刮削中和整理中的记录改为未执行

## v0.11.18 - 2025-10-24

### 修复

- 修复 openlist 查询文件列表时，3 层以上路径可能查询失败的问题
- 修复 AI 强制识别失败没有回退到正则的问题
- 修复部分刮削失败的情况没有将状态改为失败或待刮削
- 修复如果没有刮削目录会导致整理一直不执行的问题
- 修复刮削中文件下载失败也标记为成功的问题
- 每次启动刮削扫描时，将刮削中的记录改为待刮削，防止卡死
- 每次启动整理时，将整理中的记录改为已刮削，防止卡死

### 优化

- 发送 TG 通知时，不再使用临时刮削的海报，而是直接使用 tmdb 中的海报，这样可以简化删除临时文件的逻辑减少错误发生。
- 刮削记录列表将所选操作显示出来，如果没有选择项则禁用操作按钮
- 整理失败的刮削记录标记为失败，防止重试导致的性能浪费

### 新增

- 程序启动时，将所有刮削中的记录改为待刮削
- 程序启动时，将所有整理中的记录改为已刮削
- 115 同步时，排除文件夹名为一堆星号的目录
- 整理启用多线程，默认并发 5，如果是本地文件整理则使用 tmdb 设置中的 刮削本地文件线程数
- 刮削记录列表增加按照文件名搜索
- 刮削记录页面新增将所选记录标记为待整理的操作按钮，方式重试整理失败的记录

## v0.11.17 - 2025-10-23

### 修复

- 继续优化 AI 识别逻辑，首先从文件名提取然后去 tmdb 查询，如果查不到再从文件夹名字提取再去 tmdb 查询。
- 优化错别字和前端图标
- 修复 openlist 文件上传，原因是：仅刮削模式的目标路径为空，导致目标路径生成错误。

### 变更

- TMDB 设置增加本地刮削并发数设置，如果添加了自己的 TMDB API KEY 就可以修改并发数，提高刮削效率，只有本地目录可用。

## v0.11.16 - 2025-10-22

### 修复

- 网盘删除的元数据，如果选择了网盘不存在的元数据 - 保留 ，本地也不删除
- 识别[01]这种集序号，正确提取为第 1 集
- 电视剧使用了电影的二级分类，导致空指针错误
- 编辑时会视频扩展名和添加时视频扩展名的默认值不同

### 新增

- 刮削目录添加时增加 fanart.tv 的开关，因为 fanart.tv 下载很慢，不需要高清图可用关掉提高刮削效率(默认为关闭)
- 本地目录的整理支持复制方式
- 刮削记录新增刮削任务和整理任务的状态

### 变更

- 整理和刮削分离，这样刮削好的可以快速被整理（整理每 3 分钟运行一次, 不受定时任务开关控制）

## v0.11.15 - 2025-10-21

### Added

- 刮削整理时，如果文件夹或者文件名模板为空，则使用原始的名字
- 下载队列增加限速器，使用下载 QPS
- 修改 sqlite 连接参数，提高并发性能
- 刮削任务和 strm 同步任务使用哦同一个队列处理，防止两个任务一起执行突破 115QPS 限制
- 每次启动时检查数据库是否被锁定，如果锁定则强制解锁
- 每次关闭时项目触发日志文件关闭以正确 Rotate
- 修正电影清理刮削临时文件的逻辑，只有当全部临时文件都处理完成时才将刮削状态设置为完成，然后发送通知
- 用 TMDB ID 来重新识别，如果是电视剧可选加入季和集序号
- 电视剧季集序号增加规则：SXEPX

### Changed

- 115 刷新 token 接口超时时间改为 2 分钟
- strm 同步后取消 emby 媒体信息提取，防止 emby 被干死。需要提取可以在不观看的时候手动触发。

### Fixed

- 刮削和整理 - 复制 没有修改文件名
- 刮削和整理 - 复制 修改了源目录中的文件名
- 上传队列没有数据

## v0.11.14 - 2025-10-21

### Fixed

- 修复 115 播放链接 403 问题
- 修复仅刮削时文件名生成错误的问题

### Changed

- 优化 Emby 媒体信息提取，现在提取任务会加入下载队列，避免跳过下载 QPS 触发 115 限制
- 刮削时支持读取 strm 文件内容来提取对应视频文件的媒体信息（如果使用 qmediasync，请打开本地播放代理，否则无法提取）

## v0.11.13 - 2025-10-21

### Fixed

- 修正电影二级分类计算错误的问题

## v0.11.12 - 2025-10-20

### Fixed

- 修正刮削时季 nfo 文件名字错误导致上传失败的问题
- 修正电视剧刮削完成的判断逻辑，防止误删文件

### Changed

- 重构下载队列，增加清除所有任务的功能

### Added

- 增加上传下载队列列表
- 增加识别 S01 格式的季文件夹
- strm 同步时如果 115 返回文件不存在，则跳过该文件

## v0.11.11 - 2025-10-20

### Fixed

- 还原 strm 设置 本代播放代理 默认关闭；8095-强制 302 直链，其他端口根据 本地播放代理 来决定是否启动播放代理
- 修正电视剧刮削后没有正确上传季元数据，以及因为过早删除电视剧封面导致通知发送失败的问题

## v0.11.10 - 2025-10-19

### Fixed

- 修正下载队列没有删除完成的任务导致新任务无法加入队列的问题

### Changed

- 刮削时电影的 nfo 文件依然跟随文件名

## v0.11.9 - 2025-10-19

### Added

- 刮削目录可以开启/关闭定时任务

### Fixed

- 未使用代理时，Telegram 机器人连接失败问题
- Emby 服务器地址为空不能保存的问题
- 修正刮削完成的通知失败问题（图片路径取错了）

## v0.11.8 - 2025-10-19

### Added

- 115 刮削支持创建多段路径（文件夹命名规则中多级目录用/分割，如 test/{year}/{title} ({year})）
- 未完成的删除刮削记录（包括对应的文件缓存，临时文件等）
- 已刮削状态可以标记为已整理
- 替换日志写入和轮换工具
- 刮削完成发送通知
- 仅刮削模式使用 名字-poster.jpg 的命名方式，刮削和整理使用 poster.jpg 的命名方式
- 提取媒体信息的日志记录在 app.log 中
- fanart.tv 对接下载电影的高清图

### Fixed

- 修正网络代理为空不能保存

## v0.11.7 - 2025-10-19

### Fixed

- 115 查询文件详情接口超时时间改为 60s，降低因为某一个文件超时导致同步失败的问题
- 继续优化 AI 强制识别规则，如果强制识别失败，也会退回正则识别
- 如果目标目录已经存在相同文件名的文件，就不会再移动了
- 修正 AI 识别时错误传递参数导致电影用电视剧来搜索的问题
- 修正 OPENLIST 的刮削逻辑

### Changed

- 去除日志中的 token 等敏感信息

## v0.11.6 - 2025-10-18

### Fixed

- 修正正则识别时，不会清除”第 x 集“导致识别失败的问题
- 修正识别规则，没有正确使用 AI 辅助识别的问题

## v0.11.5 - 2025-10-18

### Fixed

- 修正由于默认打开了本地代理导致 8095 有些客户端无法播放的问题
- 修正 tmdb 搜索电视剧时的参数，使用 year 而不是 first_air_date_year

## v0.11.4 - 2025-10-18

### Fixed

- 如果启用了 AI 辅助识别，会在正则识别后查询 TMDB，如果查询不到直接用 AI 辅助识别
- 修正电视剧整理时上传路径没有加入季路径的问题
- 修正电视剧一集上传完成后就删除了整部剧的临时文件，导致其他集整理失败的问题
- 修正重新识别无法更新电视剧中其他集的识别信息的问题
- 优化正则识别，修正音轨 7.1,2.0 等导致的识别失败问题
- 修正二级分类计算不准确的问题
- 修正二级分类不会自动创建目标目录的问题
- 如果更改 AI 模型，必须填自己的 API KEY
- 修正电影的 IMDB_ID 没有正确保存的问题（imdb_id 后续用来下载高清图片）
- 本地类型的同步目录修改自定义设置以后没有正确显示的问题，网页上看起来好像没修改实际已经生效
- 刮削完成会正确删除网盘中的季文件夹和电视剧文件夹（如果开启了删除目录，因为这两个目录一般都不会为空）

### Added

- 每次启动时会将整理中的刮削记录重置为刮削完成以继续进行整理任务
- 新增一键清除失败的刮削记录（可以触发重新识别刮削）
- 新增开关：刮削整理完成后删除非空的来源目录（解决剩余一堆垃圾广告文件的问题）
- subs 字幕文件夹和 exfanarts 剧照文件夹会被移动到新目录下
- 背景音乐 theme.mp3 也会被移动到新目录下

## v0.11.3 - 2025-10-17

### Fixed

- Emby 提取媒体信息时，参数有误导致漏掉某些影视剧
- AI 识别接口去掉 EnableThinking 参数,因为不是所有模型都支持
- AI 强制失败如果失败，则退回正则识别

### Add

- strm 同步时，支持 exfanarts 目录的上传

## v0.11.2 - 2025-10-17

### Fixed

- 修正了编辑刮削目录时如果修改了目标路径因为没有重建二级分类依然会被整理到旧文件夹的问题
- 修正删除刮削目录时没有清除关联的刮削记录和二级分类可能导致残留的刮削记录一直失败的问题
- 刮削记录列表没有显示出来失败原因
- 刮削目录没有保存 AI 设置和演员头像设置
- 仅刮削隐藏文件重命名模板、目标路径
- 修正 TMDB 没办法保存首选图片语言的问题

## v0.11.1 - 2025-10-17

### Fixed

- 修正重新识别报错导致程序退出
- 修正重新识别没有更改状态导致不会继续刮削
- 修正 emby 提取媒体信息时没有过滤电视剧导致有部分请求报错
- 修正全新启动时没有创建设置表的问题

## v0.11 - 2025-10-17

### Added

- 刮削和整理
- Emby 媒体信息提取

### Fixed

- 如果本地存在 strm 文件，然后新同步目录，第一次全量同步时会删除 strm
- openlist 添加时无法授权

## v0.10.27 - 2025-10-16

### Fixed

- 修正上传下载队列为 1 导致的上传下载没办法异步执行的问题

## v0.10.26 - 2025-10-14

### Added

- Emby 增加智能判断，8095 端口-302 重定向到 115 下载链接，8096-通过本地代理访问 115 下载链接，基本解决 UA 问题导致的不能播放。

## v0.10.25 - 2025-10-14

### Fixed

- emby 302 播放本地文件时没有处理 universal 路径，导致无限跳转的问题

## v0.10.24 - 2025-10-12
### Fixed
* 修正8095播放本地媒体文件无限跳转的问题

## v0.10.23 - 2025-10-11
### Fixed
* 8095端口现在可以兼容本地媒体路径

## v0.10.22 - 2025-10-09
### Fixed
* 修正ssl设置,现在只需将server.crt(需要包含完整的证书链即acme.sh的fullchain.crt)和server.key(acme.sh的key文件)放入config目录即可同时启用qmediasync和外网302的ssl功能

## v0.10.21 - 2025-10-09
### Changed
* 请求115文件总数时，将limit设置为1，降低115压力，提高查询速度；请求115文件列表时，去掉不必要的参数。
### Fixed
* 当文件的父目录ID等于同步目录的ID时，将文件路径设置为空字符串，以正常处理此类文件。

## v0.10.20 - 2025-10-07
### Fixed
* 修正115接口的qps可能为0,导致无法播放的问题
### Removed
* 移除115同步时对元数据文件做的大小判断,防止因为115原因导致的重复下载元数据文件

## v0.10.19 - 2025-09-30
### Changed
* 遇到token失效时重试请求以使用新的token
* 遇到访问量过高时，休息30秒后重试，如果3次仍失败，则返回错误
* 同步失败时记录实际的失败原因

## v0.10.18 - 2025-09-29
### Changed
* 重构上传下载队列，去掉锁，防止死锁导致崩溃

## v0.10.17 - 2025-09-28
### Changed
* 
* Reconstruction of 115 rate limiter

## v0.10.16 - 2025-09-23
### Fixed
* 编辑同步目录时STRM存放目录的路径分隔符错误的问题
* openlist同步时移动云盘报错的问题

## v0.10.15 - 2025-09-23
### Changed
* 115查询文件列表并发改为5，查询文件详情并发改为3，去掉全局暂停，增加限速

## v0.10.14 - 2025-09-22
### Changed
* 115访问凭证刷新改用定时任务控制，115接口调用不再触发刷新
* 115同步改为并发10线程，提高全量和增量的同步效率
## v0.10.13 - 2025-09-21
### Fixed
* 修正本地目录类型的同步目录在同步时会删除已有的strm文件

## v0.10.12 - 2025-09-21
### Changed
* 删除同步目录时暂时禁用自动删除目录路径，先观察是否稳定
### Fixed
* 本地目录类型由于源路径前面的/被删除导致无法同步
* 添加本地目录类型的同步目录时，不自动创建源路径+目标路径的STRM存放目录

## v0.10.11 - 2025-09-19
### Fixed
* 解决死锁导致的无法请求115接口

## v0.10.10 - 2025-09-19
### Fixed
* 刷新115访问凭证时增加读写锁，防止多线程同时进行导致token失效
* 修正遗留导致的同步无法开始（检查115始终未授权）

## v0.10.9 - 2025-09-19
### Fixed
* 修正任务详情文件对比去掉任务详情的收集目录结构阶段
* 修正任务详情文件对比的分页错误

## v0.10.8 - 2025-09-19
### Fixed
* 修正openlist添加和编辑时因为缓存无法使用新数据的问题

## v0.10.7 - 2025-09-19
### Changed
* 115改为全量同步和增量同步，逻辑完全区分；全量同步会生成目录树缓存文件，增量同步只根据目录树缓存文件比对，目录树缓存永不过期，需要时手动全量同步
### Fixed
* 修复添加和编辑同步目录时STRM存放目录的路径计算错误
* 错别字修复

## v0.10.6 - 2025-09-19
### Added
* 增加元数据下载开关，如果关闭元数据下载则关闭元数据上传
### Changed
* 删除.meta隐藏文件，每次上传时主动查询目录ID
* 115同步时去掉采集目录结构阶段
### Fixed
* 修正115上传逻辑

## v0.10.5 - 2025-09-18
### Fixed
* 修正115同步时多线程资源竞争问题

## v0.10.4 - 2025-09-18
### Added
* 增加openlist上传元数据
### Fixed
* 打开上传下载元数据

## v0.10.3 - 2025-09-18
### Fixed
* 修正115同步时报错的问题：多线程资源竞争
* 修正添加openlist账号显示未授权：如果错误增加错误提示，如果正确则成功显示授权
* 修正115访问凭证失效和过期的处理逻辑，失效时发送电报通知重新授权；过期正确刷新访问凭证
* 修正windows下目录选择接口返回错误时依然会选中错误的目录
* 修正115和openlist添加同步目录时选择目录会报错的问题
* 修正openlist版本strm的链接不对的问题
## v0.10.2 - 2025-09-18
### Fixed
* 修正115同步时报错的问题：多线程资源竞争
* 修正添加openlist账号显示未授权：如果错误增加错误提示，如果正确则成功显示授权
* 修正115访问凭证失效和过期的处理逻辑，失效时发送电报通知重新授权；过期正确刷新访问凭证
* 修正windows下目录选择接口返回错误时依然会选中错误的目录
* 修正115和openlist添加同步目录时选择目录会报错的问题
## v0.10.1 - 2025-09-17
### Fixed
* 新增ChangeLog生成器

## v0.10 - 2025-09-17
### Fixed
- 修正最小视频大小无法设置为0的问题
- 修正来源路径下没有文件夹导致无法同步的问题
- 修正同步记录无法删除的问题
- 修正同步时要删除的文件路径取值错误问题
- 修正编辑115的同步目录选择来源路径无法返回上一级的问题
- 修正首页上传下载中的待处理数量不正确的问题

Features:
- 优化115同步效率
- 新增OpenList同步源