# Changelog

## v0.11.34 - 2025-11-04

### 修复

- 修复 openlist 无法同步 strm 的问题
- 修复编辑刮削目录时，删除整理完的非空路径 选项没有正确显示的问题

### 优化

- 启动时将上传中和下载中的记录改为待上传和待下载，好让上传下载继续完成

## v0.11.33 - 2025-11-04

### 修复

- 115 token 刷新没有更新全部 115 客户端的 token 导致可能同步失败的问题
- 上传下载队列限速没生效的问题

## v0.11.32 - 2025-11-04

### 修复

- openlist emby 302 多添加了一个参数，导致无法播放的问题
- 继续优化 Postgres 数据库权限问题，确保 qms 用户可以读写数据库相关的所有目录
- 修复所有创建的文件权限为 777,让 emby 可以删除

### 优化

- strm 同步目录添加编辑窗口，优化扩展名的输入，可以一次性输入多个逗号分隔的扩展名再回车统一加入
- 放开下载线程数设置

### 遗留问题

- openlist 同步依然存在问题，可能卡死，下个版本处理

## v0.11.31 - 2025-11-04

### 优化

- 继续优化 docker 权限问题
- 优化日志记录，添加微秒级时间戳，减少日志无用格式降低日志文件大小

### 修复

- 修复本地类型刮削目录无法修改刮削线程数的 bug

## v0.11.30 - 2025-11-03

### 修复

- 因为 postmaster.pid 存在导致 PG 启动失败，解决方案：统一使用 pg_ctl 启动停止(pg_ctl 会自动处理 postmaster.pid)
- 修复/media 或其他目录的权限问题，容器启动时会自动给/media 目录添加读写权限（666)，其他目录需要手动编辑同步目录或刮削目录（编辑或添加操作会修改目录权限）
- 修复刮削目录的最大线程数无法保存的 bug

### 优化

- 给 docker 容器添加 sudo 权限，解决在容器中执行需要 sudo 权限的命令问题
- 修改同步或刮削目录时，自动使用 sudo 给来源或目标目录添加读写权限（666）

## v0.11.29 - 2025-11-03

### 优化

- docker 镜像使用 qms 用户启动，解决 root 用户启动带来的一系列权限问题
- 数据库初始化脚本使用 qms 用户执行，避免权限问题

### 修复

- windows 包没有 PG 数据库可执行文件问题

### 其他未处理问题

- linux 和 mac 下现在没有 PG 数据库，需要手动安装并设置环境变量使用

## v0.11.28 - 2025-11-03

### 修复

- 减少初始化线程数量，防止内存溢出而崩溃(目前发现的问题时 openlist 同步崩溃，CD2 挂载同步崩溃，这两个都已修复)
- strm 同步和刮削目录，选择 openlist 目录时，也添加上级目录选项

### 优化

- 115 接口速率限制，将 strm 同步/刮削整理 和 普通操作区分，防止同步和刮削时阻塞普通操作（比如目录选择、播放等）

## v0.11.27 - 2025-11-02

### 修复

- 修复目录选择没有上一级的问题
- 修复同步目录列表运行状态后面一直跟一个未执行的问题
- 修复 strm 同步定时任务不会执行的问题

### 优化

- 播放链接关闭限速器，防止 strm 同步和刮削整理挤占 QPS 导致无法获取播放链接
- 去掉 strm 同步定时任务的半小时一次限制，现在可以完全自定义 CRON 表达式

### 新增

- 支持连接外部 PG 数据库，需要设置对应的环境变量
  - `DB_HOST` （外部数据库的主机名，如：192.168.1.1）
  - `DB_PORT` （外部数据库的端口 ，默认 `5432`）
  - `DB_USER` （外部数据库的用户名）
  - `DB_PASSWORD` （外部数据库的密码）
  - `DB_NAME` (外部数据库的数据库名称，可选，默认 `qms` 如果 qms 不存在且 USER 没有权限创建数据库则无法启动)
  - `DB_SSLMODE` (可选，默认 `disable`)

## v0.11.26 - 2025-11-02

### 修复

- 修复数据库初始化时，postgres 用户创建失败的问题
- 修复 docker 镜像没有默认安装 postgresql 的问题

## v0.11.25 - 2025-10-29

### 新增

- 数据库从 sqlite 迁移到 postgresql
- 上传下载队列迁移到数据库，减少内存占用，前端增加相应功能：
  - 查看上传下载队列
  - 暂停启动上传下载队列
  - 清空未完成的任务
- Openlist 和本地挂载类型的 STRM 同步，也使用接口速率中接口 QPS 来启动并发处理，提高效率
- 115 类型的 STRM 中的链接修改为：http://192.168.1.1:12333/115/newurl?pickcode=xxxxxxx
- openlist 类型的 STRM 中的链接修改为 openlist 文件链接：http://192.168.1.1:5244/d/xxxxxxx.mkv?sign=xxxxx
- 增加 AI 接口超时时间设置
- 如果识别时查询到多部影视剧，则停止识别并标记为错误，防止识别并整理到错的文件夹

### 优化

- 刮削目录添加或编辑时，如果是 115 类型，使用文件夹 ID 查询一次真实路径，防止错误
- 前端添加刮削目录独立页面，用户取消选择目录弹窗时，不处理后续的接口目录接口返回（防止意外选择错误文件夹）
- 同步任务详情页面删除比对数据，按照新的任务执行逻辑显示时间线
- strm 同步任务增加启动和停止功能，同步目录列表会显示当前同步目录的运行状态

### 修复

- 修复电影和电视剧二级分类计算不正确的问题

## v0.11.24 - 2025-10-28

### 优化

- 重构电视剧刮削逻辑，剧、季、集都增加 10 分钟超时，到期未响应或处理完就自动终止（下次再处理，防止卡死）
- 刮削整理增加了启动任务、停止任务
- 电视剧每一集处理完检查整部剧是否完成，这个过程增加处理队列保证唯一性（防止多次处理同一部剧）
- 优化刮削记录页面，重新设计表格，给每一个状态增加提示文字（显示这个状态的含义以及接下来会做什么）

### 修复

- 修复喝咖啡二维码某些设备不显示的巨大 bug

## v0.11.23 - 2025-10-27

### 修复

- 刮削记录搜索时总数没有跟随搜索条件变化
- AI 识别失败时会报空指针错误导致异常退出的问题
- 重构二级分类识别逻辑
- 视频扩展名没有取默认值的问题（重置表单会导致扩展名丢失）
- 修复 Openlist 整理时 改名错误，改为先 改名 后移动或复制
- 修复从文件夹名字中提取 tmdb id 的正则

### 优化

- 刮削记录名称搜素支持：文件路径或者识别名模糊搜索
- 8095 端口重定向时，如果链接包含 smartstrm，则不附加 force 参数
- emby 反代的 8094 和 8095 接口全部启用
- 优化刮削文件已存在的逻辑，减少误判
- 去掉单独的整理任务，合并刮削和整理，刮削完成立马整理
- 正则从文件名字中提取到年份+名字才会取 tmdb 查询，否则先从文件夹中提取名字+年份，合并数据后再查询

## v0.11.22 - 2025-10-27

### 修复

- 修复正则提取时如果文件命中提取的名称+年份搜不为空但是搜不到影片时也不会使用文件夹的信息搜索的问题。

### 优化

- 正则提取规则新增删除 xxfps 字样，例如：24fps

## v0.11.21 - 2025-10-27

### 修复

- 修复本地刮削整理时无法完成的问题（整理其实已经完成了，但是没有标记为已整理）

### 优化

- 整理电视剧时，会将正在处理的集改为整理中显示在页面上（仅优化页面显示，逻辑上没有变化）

## v0.11.20 - 2025-10-26

### 新增

- 刮削识别时新增一批正则匹配规则，可以提取更多格式的文件名

### 修复

- 修复整理完成发送通知时，可能产生的空指针错误

## v0.11.19 - 2025-10-26

### 修复

- 电影的文件夹名字的正则识别结果查询失败后，没有触发 AI 识别的问题
- 修复已本和 openlist 的已刮削文件列表记录了两次的问题

### 优化

- 记录更多刮削日志，方便排查问题
- 程序启动时，将所有刮削中和整理中的记录改为未执行

## v0.11.18 - 2025-10-24

### 修复

- 修复 openlist 查询文件列表时，3 层以上路径可能查询失败的问题
- 修复 AI 强制识别失败没有回退到正则的问题
- 修复部分刮削失败的情况没有将状态改为失败或待刮削
- 修复如果没有刮削目录会导致整理一直不执行的问题
- 修复刮削中文件下载失败也标记为成功的问题
- 每次启动刮削扫描时，将刮削中的记录改为待刮削，防止卡死
- 每次启动整理时，将整理中的记录改为已刮削，防止卡死

### 优化

- 发送 TG 通知时，不再使用临时刮削的海报，而是直接使用 tmdb 中的海报，这样可以简化删除临时文件的逻辑减少错误发生。
- 刮削记录列表将所选操作显示出来，如果没有选择项则禁用操作按钮
- 整理失败的刮削记录标记为失败，防止重试导致的性能浪费

### 新增

- 程序启动时，将所有刮削中的记录改为待刮削
- 程序启动时，将所有整理中的记录改为已刮削
- 115 同步时，排除文件夹名为一堆星号的目录
- 整理启用多线程，默认并发 5，如果是本地文件整理则使用 tmdb 设置中的 刮削本地文件线程数
- 刮削记录列表增加按照文件名搜索
- 刮削记录页面新增将所选记录标记为待整理的操作按钮，方式重试整理失败的记录

## v0.11.17 - 2025-10-23

### 修复

- 继续优化 AI 识别逻辑，首先从文件名提取然后去 tmdb 查询，如果查不到再从文件夹名字提取再去 tmdb 查询。
- 优化错别字和前端图标
- 修复 openlist 文件上传，原因是：仅刮削模式的目标路径为空，导致目标路径生成错误。

### 变更

- TMDB 设置增加本地刮削并发数设置，如果添加了自己的 TMDB API KEY 就可以修改并发数，提高刮削效率，只有本地目录可用。

## v0.11.16 - 2025-10-22

### 修复

- 网盘删除的元数据，如果选择了网盘不存在的元数据 - 保留 ，本地也不删除
- 识别[01]这种集序号，正确提取为第 1 集
- 电视剧使用了电影的二级分类，导致空指针错误
- 编辑时会视频扩展名和添加时视频扩展名的默认值不同

### 新增

- 刮削目录添加时增加 fanart.tv 的开关，因为 fanart.tv 下载很慢，不需要高清图可用关掉提高刮削效率(默认为关闭)
- 本地目录的整理支持复制方式
- 刮削记录新增刮削任务和整理任务的状态

### 变更

- 整理和刮削分离，这样刮削好的可以快速被整理（整理每 3 分钟运行一次, 不受定时任务开关控制）

## v0.11.15 - 2025-10-21

### Added

- 刮削整理时，如果文件夹或者文件名模板为空，则使用原始的名字
- 下载队列增加限速器，使用下载 QPS
- 修改 sqlite 连接参数，提高并发性能
- 刮削任务和 strm 同步任务使用哦同一个队列处理，防止两个任务一起执行突破 115QPS 限制
- 每次启动时检查数据库是否被锁定，如果锁定则强制解锁
- 每次关闭时项目触发日志文件关闭以正确 Rotate
- 修正电影清理刮削临时文件的逻辑，只有当全部临时文件都处理完成时才将刮削状态设置为完成，然后发送通知
- 用 TMDB ID 来重新识别，如果是电视剧可选加入季和集序号
- 电视剧季集序号增加规则：SXEPX

### Changed

- 115 刷新 token 接口超时时间改为 2 分钟
- strm 同步后取消 emby 媒体信息提取，防止 emby 被干死。需要提取可以在不观看的时候手动触发。

### Fixed

- 刮削和整理 - 复制 没有修改文件名
- 刮削和整理 - 复制 修改了源目录中的文件名
- 上传队列没有数据

## v0.11.14 - 2025-10-21

### Fixed

- 修复 115 播放链接 403 问题
- 修复仅刮削时文件名生成错误的问题

### Changed

- 优化 Emby 媒体信息提取，现在提取任务会加入下载队列，避免跳过下载 QPS 触发 115 限制
- 刮削时支持读取 strm 文件内容来提取对应视频文件的媒体信息（如果使用 qmediasync，请打开本地播放代理，否则无法提取）

## v0.11.13 - 2025-10-21

### Fixed

- 修正电影二级分类计算错误的问题

## v0.11.12 - 2025-10-20

### Fixed

- 修正刮削时季 nfo 文件名字错误导致上传失败的问题
- 修正电视剧刮削完成的判断逻辑，防止误删文件

### Changed

- 重构下载队列，增加清除所有任务的功能

### Added

- 增加上传下载队列列表
- 增加识别 S01 格式的季文件夹
- strm 同步时如果 115 返回文件不存在，则跳过该文件

## v0.11.11 - 2025-10-20

### Fixed

- 还原 strm 设置 本代播放代理 默认关闭；8095-强制 302 直链，其他端口根据 本地播放代理 来决定是否启动播放代理
- 修正电视剧刮削后没有正确上传季元数据，以及因为过早删除电视剧封面导致通知发送失败的问题

## v0.11.10 - 2025-10-19

### Fixed

- 修正下载队列没有删除完成的任务导致新任务无法加入队列的问题

### Changed

- 刮削时电影的 nfo 文件依然跟随文件名

## v0.11.9 - 2025-10-19

### Added

- 刮削目录可以开启/关闭定时任务

### Fixed

- 未使用代理时，Telegram 机器人连接失败问题
- Emby 服务器地址为空不能保存的问题
- 修正刮削完成的通知失败问题（图片路径取错了）

## v0.11.8 - 2025-10-19

### Added

- 115 刮削支持创建多段路径（文件夹命名规则中多级目录用/分割，如 test/{year}/{title} ({year})）
- 未完成的删除刮削记录（包括对应的文件缓存，临时文件等）
- 已刮削状态可以标记为已整理
- 替换日志写入和轮换工具
- 刮削完成发送通知
- 仅刮削模式使用 名字-poster.jpg 的命名方式，刮削和整理使用 poster.jpg 的命名方式
- 提取媒体信息的日志记录在 app.log 中
- fanart.tv 对接下载电影的高清图

### Fixed

- 修正网络代理为空不能保存

## v0.11.7 - 2025-10-19

### Fixed

- 115 查询文件详情接口超时时间改为 60s，降低因为某一个文件超时导致同步失败的问题
- 继续优化 AI 强制识别规则，如果强制识别失败，也会退回正则识别
- 如果目标目录已经存在相同文件名的文件，就不会再移动了
- 修正 AI 识别时错误传递参数导致电影用电视剧来搜索的问题
- 修正 OPENLIST 的刮削逻辑

### Changed

- 去除日志中的 token 等敏感信息

## v0.11.6 - 2025-10-18

### Fixed

- 修正正则识别时，不会清除”第 x 集“导致识别失败的问题
- 修正识别规则，没有正确使用 AI 辅助识别的问题

## v0.11.5 - 2025-10-18

### Fixed

- 修正由于默认打开了本地代理导致 8095 有些客户端无法播放的问题
- 修正 tmdb 搜索电视剧时的参数，使用 year 而不是 first_air_date_year

## v0.11.4 - 2025-10-18

### Fixed

- 如果启用了 AI 辅助识别，会在正则识别后查询 TMDB，如果查询不到直接用 AI 辅助识别
- 修正电视剧整理时上传路径没有加入季路径的问题
- 修正电视剧一集上传完成后就删除了整部剧的临时文件，导致其他集整理失败的问题
- 修正重新识别无法更新电视剧中其他集的识别信息的问题
- 优化正则识别，修正音轨 7.1,2.0 等导致的识别失败问题
- 修正二级分类计算不准确的问题
- 修正二级分类不会自动创建目标目录的问题
- 如果更改 AI 模型，必须填自己的 API KEY
- 修正电影的 IMDB_ID 没有正确保存的问题（imdb_id 后续用来下载高清图片）
- 本地类型的同步目录修改自定义设置以后没有正确显示的问题，网页上看起来好像没修改实际已经生效
- 刮削完成会正确删除网盘中的季文件夹和电视剧文件夹（如果开启了删除目录，因为这两个目录一般都不会为空）

### Added

- 每次启动时会将整理中的刮削记录重置为刮削完成以继续进行整理任务
- 新增一键清除失败的刮削记录（可以触发重新识别刮削）
- 新增开关：刮削整理完成后删除非空的来源目录（解决剩余一堆垃圾广告文件的问题）
- subs 字幕文件夹和 exfanarts 剧照文件夹会被移动到新目录下
- 背景音乐 theme.mp3 也会被移动到新目录下

## v0.11.3 - 2025-10-17

### Fixed

- Emby 提取媒体信息时，参数有误导致漏掉某些影视剧
- AI 识别接口去掉 EnableThinking 参数,因为不是所有模型都支持
- AI 强制失败如果失败，则退回正则识别

### Add

- strm 同步时，支持 exfanarts 目录的上传

## v0.11.2 - 2025-10-17

### Fixed

- 修正了编辑刮削目录时如果修改了目标路径因为没有重建二级分类依然会被整理到旧文件夹的问题
- 修正删除刮削目录时没有清除关联的刮削记录和二级分类可能导致残留的刮削记录一直失败的问题
- 刮削记录列表没有显示出来失败原因
- 刮削目录没有保存 AI 设置和演员头像设置
- 仅刮削隐藏文件重命名模板、目标路径
- 修正 TMDB 没办法保存首选图片语言的问题

## v0.11.1 - 2025-10-17

### Fixed

- 修正重新识别报错导致程序退出
- 修正重新识别没有更改状态导致不会继续刮削
- 修正 emby 提取媒体信息时没有过滤电视剧导致有部分请求报错
- 修正全新启动时没有创建设置表的问题

## v0.11 - 2025-10-17

### Added

- 刮削和整理
- Emby 媒体信息提取

### Fixed

- 如果本地存在 strm 文件，然后新同步目录，第一次全量同步时会删除 strm
- openlist 添加时无法授权

## v0.10.27 - 2025-10-16

### Fixed

- 修正上传下载队列为 1 导致的上传下载没办法异步执行的问题

## v0.10.26 - 2025-10-14

### Added

- Emby 增加智能判断，8095 端口-302 重定向到 115 下载链接，8096-通过本地代理访问 115 下载链接，基本解决 UA 问题导致的不能播放。

## v0.10.25 - 2025-10-14

### Fixed

- emby 302 播放本地文件时没有处理 universal 路径，导致无限跳转的问题

## v0.10.24 - 2025-10-12

### Fixed

- 修正 8095 播放本地媒体文件无限跳转的问题

## v0.10.23 - 2025-10-11

### Fixed

- 8095 端口现在可以兼容本地媒体路径

## v0.10.22 - 2025-10-09

### Fixed

- 修正 ssl 设置,现在只需将 server.crt(需要包含完整的证书链即 acme.sh 的 fullchain.crt)和 server.key(acme.sh 的 key 文件)放入 config 目录即可同时启用 qmediasync 和外网 302 的 ssl 功能

## v0.10.21 - 2025-10-09

### Changed

- 请求 115 文件总数时，将 limit 设置为 1，降低 115 压力，提高查询速度；请求 115 文件列表时，去掉不必要的参数。

### Fixed

- 当文件的父目录 ID 等于同步目录的 ID 时，将文件路径设置为空字符串，以正常处理此类文件。

## v0.10.20 - 2025-10-07

### Fixed

- 修正 115 接口的 qps 可能为 0,导致无法播放的问题

### Removed

- 移除 115 同步时对元数据文件做的大小判断,防止因为 115 原因导致的重复下载元数据文件

## v0.10.19 - 2025-09-30

### Changed

- 遇到 token 失效时重试请求以使用新的 token
- 遇到访问量过高时，休息 30 秒后重试，如果 3 次仍失败，则返回错误
- 同步失败时记录实际的失败原因

## v0.10.18 - 2025-09-29

### Changed

- 重构上传下载队列，去掉锁，防止死锁导致崩溃

## v0.10.17 - 2025-09-28

### Changed

-
- Reconstruction of 115 rate limiter

## v0.10.16 - 2025-09-23

### Fixed

- 编辑同步目录时 STRM 存放目录的路径分隔符错误的问题
- openlist 同步时移动云盘报错的问题

## v0.10.15 - 2025-09-23

### Changed

- 115 查询文件列表并发改为 5，查询文件详情并发改为 3，去掉全局暂停，增加限速

## v0.10.14 - 2025-09-22

### Changed

- 115 访问凭证刷新改用定时任务控制，115 接口调用不再触发刷新
- 115 同步改为并发 10 线程，提高全量和增量的同步效率

## v0.10.13 - 2025-09-21

### Fixed

- 修正本地目录类型的同步目录在同步时会删除已有的 strm 文件

## v0.10.12 - 2025-09-21

### Changed

- 删除同步目录时暂时禁用自动删除目录路径，先观察是否稳定

### Fixed

- 本地目录类型由于源路径前面的/被删除导致无法同步
- 添加本地目录类型的同步目录时，不自动创建源路径+目标路径的 STRM 存放目录

## v0.10.11 - 2025-09-19

### Fixed

- 解决死锁导致的无法请求 115 接口

## v0.10.10 - 2025-09-19

### Fixed

- 刷新 115 访问凭证时增加读写锁，防止多线程同时进行导致 token 失效
- 修正遗留导致的同步无法开始（检查 115 始终未授权）

## v0.10.9 - 2025-09-19

### Fixed

- 修正任务详情文件对比去掉任务详情的收集目录结构阶段
- 修正任务详情文件对比的分页错误

## v0.10.8 - 2025-09-19

### Fixed

- 修正 openlist 添加和编辑时因为缓存无法使用新数据的问题

## v0.10.7 - 2025-09-19

### Changed

- 115 改为全量同步和增量同步，逻辑完全区分；全量同步会生成目录树缓存文件，增量同步只根据目录树缓存文件比对，目录树缓存永不过期，需要时手动全量同步

### Fixed

- 修复添加和编辑同步目录时 STRM 存放目录的路径计算错误
- 错别字修复

## v0.10.6 - 2025-09-19

### Added

- 增加元数据下载开关，如果关闭元数据下载则关闭元数据上传

### Changed

- 删除.meta 隐藏文件，每次上传时主动查询目录 ID
- 115 同步时去掉采集目录结构阶段

### Fixed

- 修正 115 上传逻辑

## v0.10.5 - 2025-09-18

### Fixed

- 修正 115 同步时多线程资源竞争问题

## v0.10.4 - 2025-09-18

### Added

- 增加 openlist 上传元数据

### Fixed

- 打开上传下载元数据

## v0.10.3 - 2025-09-18

### Fixed

- 修正 115 同步时报错的问题：多线程资源竞争
- 修正添加 openlist 账号显示未授权：如果错误增加错误提示，如果正确则成功显示授权
- 修正 115 访问凭证失效和过期的处理逻辑，失效时发送电报通知重新授权；过期正确刷新访问凭证
- 修正 windows 下目录选择接口返回错误时依然会选中错误的目录
- 修正 115 和 openlist 添加同步目录时选择目录会报错的问题
- 修正 openlist 版本 strm 的链接不对的问题

## v0.10.2 - 2025-09-18

### Fixed

- 修正 115 同步时报错的问题：多线程资源竞争
- 修正添加 openlist 账号显示未授权：如果错误增加错误提示，如果正确则成功显示授权
- 修正 115 访问凭证失效和过期的处理逻辑，失效时发送电报通知重新授权；过期正确刷新访问凭证
- 修正 windows 下目录选择接口返回错误时依然会选中错误的目录
- 修正 115 和 openlist 添加同步目录时选择目录会报错的问题

## v0.10.1 - 2025-09-17

### Fixed

- 新增 ChangeLog 生成器

## v0.10 - 2025-09-17

### Fixed

- 修正最小视频大小无法设置为 0 的问题
- 修正来源路径下没有文件夹导致无法同步的问题
- 修正同步记录无法删除的问题
- 修正同步时要删除的文件路径取值错误问题
- 修正编辑 115 的同步目录选择来源路径无法返回上一级的问题
- 修正首页上传下载中的待处理数量不正确的问题

Features:

- 优化 115 同步效率
- 新增 OpenList 同步源
